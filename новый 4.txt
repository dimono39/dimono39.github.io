		window.currentAnalysis = null;
		function analyzeResults() {
			console.log('üìà –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...');
			
			// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
			if (!appData.tasks || appData.tasks.length === 0) {
				showNotification('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞–Ω–∏—è', 'warning');
				return;
			}
			
			if (!appData.students || appData.students.length === 0) {
				showNotification('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É—á–∞—â–∏—Ö—Å—è', 'warning');
				return;
			}
			
			const hasResults = appData.students.some(student => {
				const studentResults = appData.results[student.id];
				return studentResults && Object.keys(studentResults).length > 0;
			});
			
			if (!hasResults) {
				showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã', 'warning');
				return;
			}
			
			// –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
			const analysis = {
				summary: {},
				byTask: [],
				byStudent: [],
				byLevel: {},
				byErrorType: {},
				correlations: [],
				insights: []
			};
			
			// 1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
			analysis.summary = calculateSummaryStatistics();
			
			// 2. –ê–Ω–∞–ª–∏–∑ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º
			analysis.byTask = analyzeTasksPerformance();
			
			// 3. –ê–Ω–∞–ª–∏–∑ –ø–æ —É—á–∞—â–∏–º—Å—è
			analysis.byStudent = analyzeStudentsPerformance();
			
			// 4. –ê–Ω–∞–ª–∏–∑ –ø–æ —É—Ä–æ–≤–Ω—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
			analysis.byLevel = analyzeByComplexityLevels();
			
			// 5. –ê–Ω–∞–ª–∏–∑ –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫
			analysis.byErrorType = analyzeByErrorTypes();
			
			// 6. –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
			analysis.correlations = findCorrelations();
			
			// 7. –ò–Ω—Å–∞–π—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
			analysis.insights = generateInsights(analysis);
			// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑
			window.currentAnalysis = analysis;
			// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
			showAnalysisResults(analysis);
		}

		function calculateSummaryStatistics() {
			console.log('üìä –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
			
			const totalStudents = appData.students.length;
			const totalTasks = appData.tasks.length;
			const maxTotalScore = calculateMaxScore();
			
			let completedStudents = 0;
			let totalScoreAll = 0;
			const scores = [];
			const grades = [];
			
			// –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É —É—á–∞—â–µ–º—É—Å—è
			appData.students.forEach(student => {
				const studentId = student.id;
				const results = appData.results[studentId] || {};
				
				let studentScore = 0;
				let completedTasks = 0;
				
				appData.tasks.forEach(task => {
					const taskId = task.id || task.number;
					const score = parseFloat(results[taskId]) || 0;
					studentScore += score;
					
					if (results[taskId] !== undefined) {
						completedTasks++;
					}
				});
				
				if (completedTasks > 0) {
					completedStudents++;
					totalScoreAll += studentScore;
					scores.push(studentScore);
					
					const grade = calculateGrade(studentScore);
					grades.push(grade);
				}
			});
			
			// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
			const avgScore = scores.length > 0 ? totalScoreAll / scores.length : 0;
			const avgPercentage = maxTotalScore > 0 ? (avgScore / maxTotalScore * 100) : 0;
			
			// –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
			const avgGrade = grades.length > 0 ? 
				grades.reduce((a, b) => a + b, 0) / grades.length : 0;
			
			// –ú–µ–¥–∏–∞–Ω–∞
			const sortedScores = [...scores].sort((a, b) => a - b);
			const medianScore = sortedScores.length > 0 ?
				sortedScores[Math.floor(sortedScores.length / 2)] : 0;
			
			// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
			const variance = scores.length > 0 ?
				scores.reduce((sum, score) => sum + Math.pow(score - avgScore, 2), 0) / scores.length : 0;
			const stdDev = Math.sqrt(variance);
			
			// –ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
			const completionRate = totalStudents > 0 ? (completedStudents / totalStudents * 100) : 0;
			
			return {
				totalStudents,
				totalTasks,
				maxTotalScore,
				completedStudents,
				completionRate: completionRate.toFixed(1),
				avgScore: avgScore.toFixed(2),
				avgPercentage: avgPercentage.toFixed(1),
				avgGrade: avgGrade.toFixed(2),
				medianScore: medianScore.toFixed(2),
				stdDev: stdDev.toFixed(2),
				minScore: scores.length > 0 ? Math.min(...scores).toFixed(2) : 0,
				maxScore: scores.length > 0 ? Math.max(...scores).toFixed(2) : 0,
				scoreRange: scores.length > 0 ? (Math.max(...scores) - Math.min(...scores)).toFixed(2) : 0
			};
		}

		function analyzeTasksPerformance() {
			console.log('üìù –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π...');
			
			const taskAnalysis = [];
			
			appData.tasks.forEach((task, taskIndex) => {
				const taskId = task.id || taskIndex;
				const maxScore = task.maxScore || 1;
				const level = task.level || 1;
				
				let totalScore = 0;
				let completedBy = 0;
				const scores = [];
				
				appData.students.forEach(student => {
					const studentId = student.id;
					const results = appData.results[studentId] || {};
					const score = parseFloat(results[taskId]) || 0;
					
					if (results[taskId] !== undefined) {
						totalScore += score;
						completedBy++;
						scores.push(score);
					}
				});
				
				const avgScore = completedBy > 0 ? totalScore / completedBy : 0;
				const percentage = maxScore > 0 ? (avgScore / maxScore * 100) : 0;
				
				// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–æ–Ω—É —Ä–µ—à–∞–µ–º–æ—Å—Ç–∏
				let zone = 'unknown';
				if (percentage >= 80) zone = 'excellent';
				else if (percentage >= 60) zone = 'good';
				else if (percentage >= 40) zone = 'average';
				else if (percentage >= 20) zone = 'weak';
				else zone = 'critical';
				
				// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
				const variance = scores.length > 0 ?
					scores.reduce((sum, score) => sum + Math.pow(score - avgScore, 2), 0) / scores.length : 0;
				const stdDev = Math.sqrt(variance);
				
				taskAnalysis.push({
					number: taskIndex + 1,
					taskId,
					description: task.description || `–ó–∞–¥–∞–Ω–∏–µ ${taskIndex + 1}`,
					level,
					maxScore,
					completedBy,
					completionRate: (completedBy / appData.students.length * 100).toFixed(1),
					avgScore: avgScore.toFixed(2),
					percentage: percentage.toFixed(1),
					zone,
					stdDev: stdDev.toFixed(2),
					discrimination: calculateDiscrimination(scores),
					difficulty: (100 - percentage).toFixed(1) // –ß–µ–º –≤—ã—à–µ - —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ
				});
			});
			
			return taskAnalysis;
		}

		function calculateDiscrimination(scores) {
			if (scores.length < 2) return 0;
			
			// –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –≤–µ—Ä—Ö–Ω—é—é –∏ –Ω–∏–∂–Ω—é—é –≥—Ä—É–ø–ø—ã (27% –ª—É—á—à–∏—Ö –∏ 27% —Ö—É–¥—à–∏—Ö)
			const sorted = [...scores].sort((a, b) => a - b);
			const n = Math.floor(scores.length * 0.27);
			
			if (n < 1) return 0;
			
			const highGroup = sorted.slice(-n);
			const lowGroup = sorted.slice(0, n);
			
			const highAvg = highGroup.reduce((a, b) => a + b, 0) / highGroup.length;
			const lowAvg = lowGroup.reduce((a, b) => a + b, 0) / lowGroup.length;
			
			// –î–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è - —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Å—Ä–µ–¥–Ω–∏–º–∏ –≤–µ—Ä—Ö–Ω–µ–π –∏ –Ω–∏–∂–Ω–µ–π –≥—Ä—É–ø–ø
			return (highAvg - lowAvg).toFixed(2);
		}

		function analyzeStudentsPerformance() {
			console.log('üë• –ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ —É—á–∞—â–∏—Ö—Å—è...');
			
			const studentAnalysis = [];
			
			appData.students.forEach((student, studentIndex) => {
				const studentId = student.id;
				const results = appData.results[studentId] || {};
				
				let totalScore = 0;
				let completedTasks = 0;
				const taskScores = [];
				const levelScores = {};
				
				appData.tasks.forEach(task => {
					const taskId = task.id || task.number;
					const score = parseFloat(results[taskId]) || 0;
					const level = task.level || 1;
					
					if (results[taskId] !== undefined) {
						totalScore += score;
						completedTasks++;
						taskScores.push({
							score,
							maxScore: task.maxScore || 1,
							percentage: task.maxScore > 0 ? (score / task.maxScore * 100) : 0,
							level
						});
						
						// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —É—Ä–æ–≤–Ω—è–º
						if (!levelScores[level]) {
							levelScores[level] = { total: 0, count: 0 };
						}
						levelScores[level].total += score;
						levelScores[level].count++;
					}
				});
				
				const maxPossible = calculateMaxScore();
				const percentage = maxPossible > 0 ? (totalScore / maxPossible * 100) : 0;
				const grade = calculateGrade(totalScore);
				
				// –ê–Ω–∞–ª–∏–∑ –ø–æ —É—Ä–æ–≤–Ω—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
				const levelAnalysis = {};
				Object.entries(levelScores).forEach(([level, data]) => {
					const avg = data.count > 0 ? data.total / data.count : 0;
					levelAnalysis[level] = {
						avgScore: avg.toFixed(2),
						completionRate: (data.count / appData.tasks.filter(t => t.level == level).length * 100).toFixed(1)
					};
				});
				
				// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
				const strengths = [];
				const weaknesses = [];
				
				taskScores.forEach((taskScore, index) => {
					if (taskScore.percentage >= 80) {
						strengths.push(index + 1);
					} else if (taskScore.percentage <= 40) {
						weaknesses.push(index + 1);
					}
				});
				
				// –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
				const stability = calculateStability(taskScores.map(t => t.percentage));
				
				studentAnalysis.push({
					id: studentId,
					index: studentIndex,
					name: `${student.lastName} ${student.firstName}`,
					totalScore: totalScore.toFixed(2),
					maxPossible,
					percentage: percentage.toFixed(1),
					grade,
					completedTasks,
					completionRate: (completedTasks / appData.tasks.length * 100).toFixed(1),
					levelAnalysis,
					strengths: strengths.slice(0, 3),
					weaknesses: weaknesses.slice(0, 3),
					stability: stability.toFixed(2),
					rank: 0 // –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ–∑–∂–µ
				});
			});
			
			// –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –±–∞–ª–ª–∞–º –∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —Ä–∞–Ω–≥–∏
			studentAnalysis.sort((a, b) => b.totalScore - a.totalScore);
			studentAnalysis.forEach((student, index) => {
				student.rank = index + 1;
				student.percentile = ((1 - index / studentAnalysis.length) * 100).toFixed(1);
			});
			
			return studentAnalysis;
		}

		function calculateStability(percentages) {
			if (percentages.length < 2) return 100;
			
			// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ (–Ω–∏–∂–µ = —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ)
			const mean = percentages.reduce((a, b) => a + b, 0) / percentages.length;
			const variance = percentages.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) / percentages.length;
			const stdDev = Math.sqrt(variance);
			const cv = (stdDev / mean) * 100;
			
			// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (0-100)
			return Math.max(0, 100 - cv);
		}

		function analyzeByComplexityLevels() {
			console.log('üéØ –ê–Ω–∞–ª–∏–∑ –ø–æ —É—Ä–æ–≤–Ω—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏...');
			
			const levelAnalysis = {};
			
			// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è
			for (let level = 1; level <= 4; level++) {
				levelAnalysis[level] = {
					count: 0,
					totalMaxScore: 0,
					totalActualScore: 0,
					studentsCompleted: 0,
					tasks: []
				};
			}
			
			// –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É —É—Ä–æ–≤–Ω—é
			appData.tasks.forEach((task, taskIndex) => {
				const level = task.level || 1;
				const taskId = task.id || taskIndex;
				const maxScore = task.maxScore || 1;
				
				let taskTotalScore = 0;
				let studentsCompleted = 0;
				
				appData.students.forEach(student => {
					const studentId = student.id;
					const results = appData.results[studentId] || {};
					const score = parseFloat(results[taskId]) || 0;
					
					if (results[taskId] !== undefined) {
						taskTotalScore += score;
						studentsCompleted++;
					}
				});
				
				levelAnalysis[level].count++;
				levelAnalysis[level].totalMaxScore += maxScore;
				levelAnalysis[level].totalActualScore += taskTotalScore;
				levelAnalysis[level].studentsCompleted += studentsCompleted;
				
				levelAnalysis[level].tasks.push({
					number: taskIndex + 1,
					avgScore: studentsCompleted > 0 ? taskTotalScore / studentsCompleted : 0,
					completionRate: (studentsCompleted / appData.students.length * 100).toFixed(1)
				});
			});
			
			// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
			const result = {};
			
			Object.entries(levelAnalysis).forEach(([level, data]) => {
				if (data.count === 0) return;
				
				const avgPercentage = data.totalMaxScore > 0 ? 
					(data.totalActualScore / data.totalMaxScore / appData.students.length * 100) : 0;
				
				const avgCompletion = data.studentsCompleted > 0 ?
					(data.studentsCompleted / (data.count * appData.students.length) * 100) : 0;
				
				// –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
				const expectedPercentage = getExpectedLevelPercentage(parseInt(level));
				const deviation = avgPercentage - expectedPercentage;
				
				result[level] = {
					levelName: complexityLevels[level]?.name || `–£—Ä–æ–≤–µ–Ω—å ${level}`,
					taskCount: data.count,
					avgPercentage: avgPercentage.toFixed(1),
					avgCompletion: avgCompletion.toFixed(1),
					expectedPercentage,
					deviation: deviation.toFixed(1),
					performance: deviation >= 10 ? 'excellent' : 
							   deviation >= 0 ? 'good' : 
							   deviation >= -10 ? 'average' : 'weak',
					color: complexityLevels[level]?.color || '#95a5a6'
				};
			});
			
			return result;
		}

		function getExpectedLevelPercentage(level) {
			// –û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ —É—Ä–æ–≤–Ω—è–º
			const expectations = {
				1: 85, // –ë–∞–∑–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è
				2: 70, // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
				3: 50, // –ê–Ω–∞–ª–∏–∑
				4: 30  // –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ
			};
			
			return expectations[level] || 50;
		}

		function analyzeByErrorTypes() {
			console.log('üîç –ê–Ω–∞–ª–∏–∑ –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫...');
			
			const errorAnalysis = {};
			
			// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ—à–∏–±–æ–∫
			Object.keys(errorTypes).forEach(errorKey => {
				errorAnalysis[errorKey] = {
					count: 0,
					totalScore: 0,
					maxPossible: 0,
					tasks: [],
					students: new Set()
				};
			});
			
			// –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
			appData.tasks.forEach((task, taskIndex) => {
				const taskId = task.id || taskIndex;
				const errorType = task.errorType;
				
				if (!errorType || !errorAnalysis[errorType]) return;
				
				let taskTotalScore = 0;
				let taskMaxScore = 0;
				
				appData.students.forEach(student => {
					const studentId = student.id;
					const results = appData.results[studentId] || {};
					const score = parseFloat(results[taskId]) || 0;
					
					if (results[taskId] !== undefined) {
						taskTotalScore += score;
						taskMaxScore += task.maxScore || 1;
						errorAnalysis[errorType].students.add(studentId);
					}
				});
				
				errorAnalysis[errorType].count++;
				errorAnalysis[errorType].totalScore += taskTotalScore;
				errorAnalysis[errorType].maxPossible += taskMaxScore;
				
				const percentage = taskMaxScore > 0 ? (taskTotalScore / taskMaxScore * 100) : 0;
				errorAnalysis[errorType].tasks.push({
					number: taskIndex + 1,
					percentage: percentage.toFixed(1)
				});
			});
			
			// –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è
			const filteredAnalysis = {};
			
			Object.entries(errorAnalysis).forEach(([errorKey, data]) => {
				if (data.count === 0) return;
				
				const errorType = errorTypes[errorKey];
				const percentage = data.maxPossible > 0 ? 
					(data.totalScore / data.maxPossible * 100) : 0;
				const studentCount = data.students.size;
				
				filteredAnalysis[errorKey] = {
					name: errorType?.name || errorKey,
					color: errorType?.color || '#95a5a6',
					count: data.count,
					studentCount,
					percentage: percentage.toFixed(1),
					avgPerStudent: studentCount > 0 ? (data.totalScore / studentCount).toFixed(2) : 0,
					tasks: data.tasks
				};
			});
			
			return filteredAnalysis;
		}

		function findCorrelations() {
			console.log('üîó –ü–æ–∏—Å–∫ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π...');
			
			const correlations = [];
			
			if (appData.tasks.length < 2) return correlations;
			
			// –ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π –º–µ–∂–¥—É –∑–∞–¥–∞–Ω–∏—è–º–∏
			const taskScores = [];
			
			// –°–æ–±–∏—Ä–∞–µ–º –±–∞–ª–ª—ã –ø–æ –∑–∞–¥–∞–Ω–∏—è–º
			appData.tasks.forEach((task, taskIndex) => {
				const taskId = task.id || taskIndex;
				const scores = [];
				
				appData.students.forEach(student => {
					const studentId = student.id;
					const results = appData.results[studentId] || {};
					scores.push(parseFloat(results[taskId]) || 0);
				});
				
				taskScores.push(scores);
			});
			
			// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –ø–∞—Ä–∞–º–∏ –∑–∞–¥–∞–Ω–∏–π
			for (let i = 0; i < taskScores.length; i++) {
				for (let j = i + 1; j < taskScores.length; j++) {
					const correlation = calculateCorrelation(taskScores[i], taskScores[j]);
					
					if (Math.abs(correlation) > 0.5) {
						correlations.push({
							task1: i + 1,
							task2: j + 1,
							correlation: correlation.toFixed(3),
							strength: Math.abs(correlation) > 0.7 ? 'strong' : 
									 Math.abs(correlation) > 0.5 ? 'moderate' : 'weak',
							type: correlation > 0 ? 'positive' : 'negative'
						});
					}
				}
			}
			
			// –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å–∏–ª–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
			correlations.sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation));
			
			return correlations.slice(0, 10); // –¢–æ–ª—å–∫–æ —Ç–æ–ø-10
		}

		function calculateCorrelation(x, y) {
			const n = x.length;
			if (n !== y.length || n < 2) return 0;
			
			const sumX = x.reduce((a, b) => a + b, 0);
			const sumY = y.reduce((a, b) => a + b, 0);
			const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
			const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
			const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
			
			const numerator = n * sumXY - sumX * sumY;
			const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
			
			return denominator !== 0 ? numerator / denominator : 0;
		}

		function generateInsights(analysis) {
			console.log('üí° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Å–∞–π—Ç–æ–≤...');
			
			const insights = [];
			
			// 1. –ò–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
			const summary = analysis.summary;
			
			if (summary.completionRate < 50) {
				insights.push({
					type: 'warning',
					title: '–ù–∏–∑–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',
					message: `–¢–æ–ª—å–∫–æ ${summary.completionRate}% —É—á–∞—â–∏—Ö—Å—è –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è`,
					suggestion: '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π'
				});
			}
			
			if (summary.stdDev > summary.avgScore * 0.5) {
				insights.push({
					type: 'info',
					title: '–ë–æ–ª—å—à–æ–π —Ä–∞–∑–±—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤',
					message: `–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (${summary.stdDev}) —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–æ–ª–µ–µ 50% –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –±–∞–ª–ª–∞`,
					suggestion: '–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞–Ω–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω—ã–º –¥–ª—è –¥–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã'
				});
			}
			
			// 2. –ò–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–¥–∞–Ω–∏–π
			const criticalTasks = analysis.byTask.filter(task => task.zone === 'critical');
			if (criticalTasks.length > 0) {
				insights.push({
					type: 'danger',
					title: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è',
					message: `${criticalTasks.length} –∑–∞–¥–∞–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –º–µ–Ω–µ–µ —á–µ–º –Ω–∞ 20%`,
					suggestion: `–ó–∞–¥–∞–Ω–∏—è: ${criticalTasks.map(t => t.number).join(', ')}. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ.`
				});
			}
			
			// 3. –ò–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
			Object.entries(analysis.byLevel).forEach(([level, data]) => {
				if (data.deviation < -15) {
					insights.push({
						type: 'warning',
						title: `–°–ª–∞–±—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ ${data.levelName}`,
						message: `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ ${data.percentage}% (–æ–∂–∏–¥–∞–ª–æ—Å—å ${data.expectedPercentage}%)`,
						suggestion: `–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–¥–µ–ª–∏—Ç—å –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è–º —É—Ä–æ–≤–Ω—è ${level}`
					});
				}
			});
			
			// 4. –ò–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
			const weakErrorTypes = Object.entries(analysis.byErrorType)
				.filter(([_, data]) => data.percentage < 50);
			
			if (weakErrorTypes.length > 0) {
				const worst = weakErrorTypes.sort((a, b) => a[1].percentage - b[1].percentage)[0];
				insights.push({
					type: 'info',
					title: '–ü—Ä–æ–±–ª–µ–º–Ω—ã–π —Ç–∏–ø –æ—à–∏–±–æ–∫',
					message: `–ù–∞–∏–º–µ–Ω—å—à–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ —Ç–∏–ø—É "${worst[1].name}" (${worst[1].percentage}%)`,
					suggestion: '–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ'
				});
			}
			
			// 5. –ò–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π
			if (analysis.correlations.length > 0) {
				const strongest = analysis.correlations[0];
				if (Math.abs(strongest.correlation) > 0.8) {
					insights.push({
						type: 'success',
						title: '–°–∏–ª—å–Ω–∞—è –≤–∑–∞–∏–º–æ—Å–≤—è–∑—å –∑–∞–¥–∞–Ω–∏–π',
						message: `–ó–∞–¥–∞–Ω–∏—è ${strongest.task1} –∏ ${strongest.task2} —Å–∏–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç (${strongest.correlation})`,
						suggestion: '–í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–¥–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Å—Ö–æ–∂–∏–µ —É–º–µ–Ω–∏—è –∏–ª–∏ –∏–º–µ—é—Ç –æ–±—â—É—é —Ç–µ–º–∞—Ç–∏–∫—É'
					});
				}
			}
			
			// 6. –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã
			const excellentTasks = analysis.byTask.filter(task => task.zone === 'excellent');
			if (excellentTasks.length > appData.tasks.length * 0.3) {
				insights.push({
					type: 'success',
					title: '–•–æ—Ä–æ—à–µ–µ —É—Å–≤–æ–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞',
					message: `–ë–æ–ª–µ–µ 30% –∑–∞–¥–∞–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞ –æ—Ç–ª–∏—á–Ω–æ (>80%)`,
					suggestion: '–ì—Ä—É–ø–ø–∞ —Ö–æ—Ä–æ—à–æ —É—Å–≤–æ–∏–ª–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã'
				});
			}
			
			return insights;
		}

		function showAnalysisResults(analysis) {
			console.log('üìä –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞:', analysis);
			
			let html = `
				<div style="max-width: 1200px;">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
						<h3 style="margin: 0;">üìà –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
						<div>
							<button class="btn btn-sm btn-outline" onclick="exportAnalysisReport(${JSON.stringify(analysis).replace(/"/g, '&quot;')})">
								üì• –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞
							</button>
							<button class="btn btn-sm btn-outline" onclick="printAnalysisReport(${JSON.stringify(analysis).replace(/"/g, '&quot;')})">
								üñ®Ô∏è –ü–µ—á–∞—Ç—å
							</button>
						</div>
					</div>
					
					<!-- –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
					<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
						<h4 style="margin-top: 0;">üìä –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
						<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
							<div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
								<div style="font-size: 24px; font-weight: bold; color: #3498db;">
									${analysis.summary.avgPercentage}%
								</div>
								<div style="font-size: 12px; color: #666;">–°—Ä–µ–¥–Ω–∏–π % –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div>
							</div>
							
							<div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
								<div style="font-size: 24px; font-weight: bold; color: #2ecc71;">
									${analysis.summary.avgGrade}
								</div>
								<div style="font-size: 12px; color: #666;">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</div>
							</div>
							
							<div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
								<div style="font-size: 24px; font-weight: bold; color: #f39c12;">
									${analysis.summary.completionRate}%
								</div>
								<div style="font-size: 12px; color: #666;">–í—ã–ø–æ–ª–Ω–∏–ª–∏ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è</div>
							</div>
							
							<div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
								<div style="font-size: 24px; font-weight: bold; color: #e74c3c;">
									${analysis.summary.stdDev}
								</div>
								<div style="font-size: 12px; color: #666;">–†–∞–∑–±—Ä–æ—Å (œÉ)</div>
							</div>
						</div>
					</div>
					
					<!-- –ò–Ω—Å–∞–π—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
					<div style="margin-bottom: 20px;">
						<h4>üí° –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã</h4>
						<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
			`;
			
			// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å–∞–π—Ç—ã
			analysis.insights.forEach((insight, index) => {
				const bgColor = insight.type === 'danger' ? '#f8d7da' :
							   insight.type === 'warning' ? '#fff3cd' :
							   insight.type === 'info' ? '#d1ecf1' : '#d4edda';
				
				const borderColor = insight.type === 'danger' ? '#f5c6cb' :
								  insight.type === 'warning' ? '#ffeaa7' :
								  insight.type === 'info' ? '#bee5eb' : '#c3e6cb';
				
				html += `
					<div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 15px; border-radius: 8px;">
						<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
							<span style="font-size: 20px;">
								${insight.type === 'danger' ? '‚ö†Ô∏è' : 
								  insight.type === 'warning' ? '‚ö°' : 
								  insight.type === 'info' ? '‚ÑπÔ∏è' : '‚úÖ'}
							</span>
							<strong>${insight.title}</strong>
						</div>
						<div style="margin-bottom: 10px; font-size: 14px;">${insight.message}</div>
						<div style="font-size: 12px; color: #666; font-style: italic;">${insight.suggestion}</div>
					</div>
				`;
			});
			
			html += `
						</div>
					</div>
					
					<!-- –¢–∞–±—ã –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ -->
					<div style="margin-bottom: 20px;">
						<div class="tabs" style="background: #f8f9fa; border-radius: 8px; padding: 5px; display: flex; gap: 5px;">
							<button class="tab-btn" onclick="showAnalysisTab('tasks', this)" style="flex: 1;">üìù –ü–æ –∑–∞–¥–∞–Ω–∏—è–º</button>
							<button class="tab-btn" onclick="showAnalysisTab('students', this)" style="flex: 1;">üë• –ü–æ —É—á–∞—â–∏–º—Å—è</button>
							<button class="tab-btn" onclick="showAnalysisTab('levels', this)" style="flex: 1;">üéØ –ü–æ —É—Ä–æ–≤–Ω—è–º</button>
							<button class="tab-btn" onclick="showAnalysisTab('errors', this)" style="flex: 1;">üîç –ü–æ –æ—à–∏–±–∫–∞–º</button>
							<button class="tab-btn" onclick="showAnalysisTab('correlations', this)" style="flex: 1;">üîó –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏</button>
						</div>
						
						<div id="analysisTabContent" style="background: white; padding: 20px; border-radius: 0 0 8px 8px; border: 1px solid #eee; border-top: none;">
							<!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
						</div>
					</div>
				</div>
			`;
			
			showModal('–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', html);
			
			// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –≤–∫–ª–∞–¥–∫—É
			setTimeout(() => {
				showAnalysisTab('tasks', document.querySelector('.tab-btn'));
			}, 100);
		}

		function showAnalysisTab(tabName, button) {
			// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
			document.querySelectorAll('.tab-btn').forEach(btn => {
				btn.classList.remove('active');
			});
			
			// –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –∫–Ω–æ–ø–∫—É
			button.classList.add('active');
			
			const contentDiv = document.getElementById('analysisTabContent');
			if (!contentDiv) return;
			
			let html = '';
			
			switch(tabName) {
				case 'tasks':
					html = renderTasksAnalysis();
					break;
				case 'students':
					html = renderStudentsAnalysis();
					break;
				case 'levels':
					html = renderLevelsAnalysis();
					break;
				case 'errors':
					html = renderErrorsAnalysis();
					break;
				case 'correlations':
					html = renderCorrelationsAnalysis();
					break;
			}
			
			contentDiv.innerHTML = html;
		}

		function renderTasksAnalysis() {
			const analysis = window.currentAnalysis || {};
			const tasks = analysis.byTask || [];
			
			let html = `
				<h4 style="margin-top: 0;">üìù –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π</h4>
				<p style="color: #666; margin-bottom: 15px;">${tasks.length} –∑–∞–¥–∞–Ω–∏–π, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</p>
				
				<div style="max-height: 400px; overflow-y: auto;">
					<table style="width: 100%; font-size: 12px; border-collapse: collapse;">
						<thead>
							<tr>
								<th style="padding: 10px; background: #f8f9fa; text-align: center;">‚Ññ</th>
								<th style="padding: 10px; background: #f8f9fa;">–ó–∞–¥–∞–Ω–∏–µ</th>
								<th style="padding: 10px; background: #f8f9fa; text-align: center;">–£—Ä–æ–≤–µ–Ω—å</th>
								<th style="padding: 10px; background: #f8f9fa; text-align: center;">% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
								<th style="padding: 10px; background: #f8f9fa; text-align: center;">–ó–æ–Ω–∞</th>
								<th style="padding: 10px; background: #f8f9fa; text-align: center;">–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
								<th style="padding: 10px; background: #f8f9fa; text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
							</tr>
						</thead>
						<tbody>
			`;
			
			tasks.sort((a, b) => a.percentage - b.percentage).forEach(task => {
				const zoneColor = task.zone === 'excellent' ? '#27ae60' :
								 task.zone === 'good' ? '#3498db' :
								 task.zone === 'average' ? '#f39c12' :
								 task.zone === 'weak' ? '#e67e22' : '#e74c3c';
				
				const zoneName = task.zone === 'excellent' ? '–û—Ç–ª–∏—á–Ω–æ' :
								task.zone === 'good' ? '–•–æ—Ä–æ—à–æ' :
								task.zone === 'average' ? '–°—Ä–µ–¥–Ω–µ' :
								task.zone === 'weak' ? '–°–ª–∞–±–æ' : '–ö—Ä–∏—Ç–∏—á–Ω–æ';
				
				html += `
					<tr>
						<td style="padding: 8px; text-align: center; font-weight: bold;">${task.number}</td>
						<td style="padding: 8px;">${task.description.substring(0, 50)}${task.description.length > 50 ? '...' : ''}</td>
						<td style="padding: 8px; text-align: center;">
							<span style="display: inline-block; padding: 3px 8px; background: ${complexityLevels[task.level]?.color || '#95a5a6'}; color: white; border-radius: 10px;">
								${task.level}
							</span>
						</td>
						<td style="padding: 8px; text-align: center;">
							<div style="font-weight: bold;">${task.percentage}%</div>
							<div style="font-size: 10px; color: #666;">(${task.avgScore}/${task.maxScore})</div>
						</td>
						<td style="padding: 8px; text-align: center;">
							<span style="color: ${zoneColor}; font-weight: bold;">${zoneName}</span>
						</td>
						<td style="padding: 8px; text-align: center;">
							<div>${task.difficulty}</div>
							<div style="font-size: 10px; color: #666;">(—á–µ–º –≤—ã—à–µ - —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ)</div>
						</td>
						<td style="padding: 8px; text-align: center;">
							<button class="btn-icon small" onclick="showTaskDetails(${task.number - 1})" title="–î–µ—Ç–∞–ª–∏">
								üîç
							</button>
						</td>
					</tr>
				`;
			});
			
			html += `
						</tbody>
					</table>
				</div>
				
				<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
					<strong>–õ–µ–≥–µ–Ω–¥–∞ –∑–æ–Ω:</strong>
					<span style="color: #27ae60; margin-left: 10px;">‚úÖ –û—Ç–ª–∏—á–Ω–æ (>80%)</span>
					<span style="color: #3498db; margin-left: 10px;">üëç –•–æ—Ä–æ—à–æ (60-80%)</span>
					<span style="color: #f39c12; margin-left: 10px;">‚ö†Ô∏è –°—Ä–µ–¥–Ω–µ (40-60%)</span>
					<span style="color: #e67e22; margin-left: 10px;">üîª –°–ª–∞–±–æ (20-40%)</span>
					<span style="color: #e74c3c; margin-left: 10px;">üö® –ö—Ä–∏—Ç–∏—á–Ω–æ (<20%)</span>
				</div>
			`;
			
			return html;
		}



		function addErrorToStudentPrompt(studentId) {
			if (!appData.tasks || appData.tasks.length === 0) {
				showNotification('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞–Ω–∏—è', 'warning');
				return;
			}
			
			let html = `
				<div style="max-width: 500px;">
					<h4>–î–æ–±–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É —É—á–µ–Ω–∏–∫—É</h4>
					
					<div class="form-group">
						<label>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ:</label>
						<select id="errorTaskSelect" class="form-control">
							${appData.tasks.map((task, index) => `
								<option value="${task.id || index}">
									–ó–∞–¥–∞–Ω–∏–µ ${index + 1}: ${task.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}
								</option>
							`).join('')}
						</select>
					</div>
					
					<div class="form-group">
						<label>–¢–∏–ø –æ—à–∏–±–∫–∏:</label>
						<select id="errorTypeSelect" class="form-control">
							<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
							${Object.entries(errorTypes).map(([key, type]) => `
								<option value="${key}">${type.name}</option>
							`).join('')}
						</select>
					</div>
					
					<div class="form-group">
						<label>–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏:</label>
						<textarea id="errorDescription" class="form-control" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏..."></textarea>
					</div>
					
					<div style="margin-top: 20px;">
						<button class="btn btn-success" onclick="saveStudentError('${studentId}')">
							üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—à–∏–±–∫—É
						</button>
						<button class="btn btn-outline" onclick="hideModal()">
							–û—Ç–º–µ–Ω–∞
						</button>
					</div>
				</div>
			`;
			
			showModal('–î–æ–±–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É', html);
		}

		function saveStudentError(studentId) {
			const taskId = document.getElementById('errorTaskSelect').value;
			const errorType = document.getElementById('errorTypeSelect').value;
			const description = document.getElementById('errorDescription').value;
			
			if (!errorType) {
				showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—à–∏–±–∫–∏', 'error');
				return;
			}
			
			addErrorToStudent(studentId, taskId, errorType, description);
			hideModal();
			showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
		}
		// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
		function updateCellStyle(input) {
			const value = parseFloat(input.value) || 0;
			const max = parseFloat(input.max) || 1;
			
			if (value === max) {
				input.style.borderColor = '#2ecc71';
				input.style.background = '#f0fff4';
			} else if (value > 0) {
				input.style.borderColor = '#f39c12';
				input.style.background = '#fff8e1';
			} else {
				input.style.borderColor = '#e74c3c';
				input.style.background = '#fff5f5';
			}
		}

		function handleCellKeydown(e, row, col) {
			// Enter –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤–Ω–∏–∑
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				if (row < appData.students.length - 1) {
					moveToCell(row + 1, col);
				}
			}
		}

		function getPercentageColor(percentage) {
			if (percentage >= 90) return '#27ae60';
			if (percentage >= 75) return '#2ecc71';
			if (percentage >= 60) return '#3498db';
			if (percentage >= 40) return '#f39c12';
			if (percentage >= 25) return '#e67e22';
			return '#e74c3c';
		}
		
		
		// ==================== RENDER STUDENTS ANALYSIS ====================

function renderStudentsAnalysis() {
    const analysis = window.currentAnalysis || {};
    const students = analysis.byStudent || [];
    const summary = analysis.summary || {};
    
    let html = `
        <h4 style="margin-top: 0;">üë• –ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ —É—á–∞—â–∏—Ö—Å—è</h4>
        <p style="color: #666; margin-bottom: 15px;">${students.length} —É—á–∞—â–∏—Ö—Å—è, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É</p>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <select id="studentSort" onchange="sortStudentsAnalysis()" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="rank">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
                <option value="score">–ü–æ –±–∞–ª–ª–∞–º</option>
                <option value="percentage">–ü–æ % –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</option>
                <option value="stability">–ü–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏</option>
            </select>
            
            <input type="text" id="studentSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." 
                   oninput="searchStudents()" style="flex: 1; padding: 5px; border-radius: 4px; border: 1px solid #ddd;">
            
            <button class="btn btn-sm btn-outline" onclick="exportStudentList()">
                üì• –≠–∫—Å–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞
            </button>
        </div>
        
        <div style="max-height: 400px; overflow-y: auto;">
            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                    <tr>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center; width: 50px;">–†–∞–Ω–≥</th>
                        <th style="padding: 10px; background: #f8f9fa;">–£—á–∞—â–∏–π—Å—è</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center; width: 80px;">–ë–∞–ª–ª—ã</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center; width: 80px;">%</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center; width: 60px;">–û—Ü–µ–Ω–∫–∞</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center; width: 80px;">–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center; width: 100px;">–°–∏–ª—å–Ω—ã–µ/—Å–ª–∞–±—ã–µ</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center; width: 80px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="studentsAnalysisBody">
    `;
    
    // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
    students.forEach(student => {
        const gradeColor = getGradeColor(student.grade);
        const stabilityColor = student.stability >= 80 ? '#27ae60' :
                             student.stability >= 60 ? '#3498db' :
                             student.stability >= 40 ? '#f39c12' : '#e74c3c';
        
        html += `
            <tr data-student-id="${student.id}" data-student-name="${student.name.toLowerCase()}">
                <td style="padding: 8px; text-align: center; font-weight: bold;">
                    <span style="display: inline-block; width: 25px; height: 25px; background: ${student.rank <= 3 ? '#f39c12' : '#3498db'}; color: white; border-radius: 50%; line-height: 25px;">
                        ${student.rank}
                    </span>
                </td>
                <td style="padding: 8px;">
                    <div style="font-weight: 500;">${student.name}</div>
                    <div style="font-size: 10px; color: #666;">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${student.completedTasks}/${appData.tasks.length}</div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="font-weight: bold;">${student.totalScore}</div>
                    <div style="font-size: 10px; color: #666;">/${student.maxPossible}</div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="font-weight: bold; color: ${getPercentageColor(student.percentage)};">
                        ${student.percentage}%
                    </div>
                    <div style="font-size: 10px; color: #666;">${student.percentile} –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å</div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="width: 30px; height: 30px; background: ${gradeColor}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">
                        ${student.grade}
                    </div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="color: ${stabilityColor}; font-weight: bold;">${student.stability}</div>
                    <div style="font-size: 10px; color: #666;">–∏–∑ 100</div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="font-size: 10px;">
                        <span style="color: #27ae60;">–°–∏–ª—å–Ω—ã–µ: ${student.strengths.length > 0 ? student.strengths.join(',') : '-'}</span><br>
                        <span style="color: #e74c3c;">–°–ª–∞–±—ã–µ: ${student.weaknesses.length > 0 ? student.weaknesses.join(',') : '-'}</span>
                    </div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <button class="btn-icon small" onclick="showStudentDetails(${student.index})" title="–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑">
                        üìä
                    </button>
                    <button class="btn-icon small" onclick="generateStudentReport(${student.index})" title="–û—Ç—á–µ—Ç">
                        üìÑ
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        <!-- –ì—Ä—É–ø–ø–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑ -->
        <div style="margin-top: 20px;">
            <h5>üìä –ì—Ä—É–ø–ø–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <strong>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫:</strong>
                    <div style="margin-top: 10px;">
    `;
    
    // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫
    const gradeDistribution = {2: 0, 3: 0, 4: 0, 5: 0};
    students.forEach(student => {
        const grade = Math.floor(student.grade);
        if (gradeDistribution[grade] !== undefined) {
            gradeDistribution[grade]++;
        }
    });
    
    Object.entries(gradeDistribution).forEach(([grade, count]) => {
        const percentage = (count / students.length * 100).toFixed(1);
        html += `
            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>–û—Ü–µ–Ω–∫–∞ ${grade}:</span>
                <span>${count} (${percentage}%)</span>
            </div>
        `;
    });
    
    html += `
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—á–∞—â–∏—Ö—Å—è:</strong>
                    <div style="margin-top: 10px;">
    `;
    
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏
    const categories = {
        excellent: students.filter(s => s.percentage >= 80).length,
        good: students.filter(s => s.percentage >= 60 && s.percentage < 80).length,
        average: students.filter(s => s.percentage >= 40 && s.percentage < 60).length,
        weak: students.filter(s => s.percentage >= 20 && s.percentage < 40).length,
        critical: students.filter(s => s.percentage < 20).length
    };
    
    Object.entries(categories).forEach(([category, count]) => {
        const names = {
            excellent: '–û—Ç–ª–∏—á–Ω–∏–∫–∏',
            good: '–•–æ—Ä–æ—à–∏—Å—Ç—ã', 
            average: '–°—Ä–µ–¥–Ω–∏–µ',
            weak: '–°–ª–∞–±—ã–µ',
            critical: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ'
        };
        const percentage = (count / students.length * 100).toFixed(1);
        html += `
            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>${names[category]}:</span>
                <span>${count} (${percentage}%)</span>
            </div>
        `;
    });
    
    html += `
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong>
                    <div style="margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                            <span>–ú–∞–∫—Å. –±–∞–ª–ª:</span>
                            <span>${summary.maxScore}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                            <span>–ú–∏–Ω. –±–∞–ª–ª:</span>
                            <span>${summary.minScore}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                            <span>–†–∞–∑–±—Ä–æ—Å:</span>
                            <span>${summary.scoreRange}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                            <span>–ú–µ–¥–∏–∞–Ω–∞:</span>
                            <span>${summary.medianScore}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return html;
}

function sortStudentsAnalysis() {
    const sortBy = document.getElementById('studentSort').value;
    const students = window.currentAnalysis?.byStudent || [];
    
    const sorted = [...students].sort((a, b) => {
        switch(sortBy) {
            case 'score': return b.totalScore - a.totalScore;
            case 'percentage': return b.percentage - a.percentage;
            case 'stability': return b.stability - a.stability;
            default: return a.rank - b.rank;
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
    const tbody = document.getElementById('studentsAnalysisBody');
    if (tbody) {
        tbody.innerHTML = '';
        
        sorted.forEach(student => {
            const gradeColor = getGradeColor(student.grade);
            const stabilityColor = student.stability >= 80 ? '#27ae60' :
                                 student.stability >= 60 ? '#3498db' :
                                 student.stability >= 40 ? '#f39c12' : '#e74c3c';
            
            const row = document.createElement('tr');
            row.dataset.studentId = student.id;
            row.dataset.studentName = student.name.toLowerCase();
            row.innerHTML = `
                <td style="padding: 8px; text-align: center; font-weight: bold;">
                    <span style="display: inline-block; width: 25px; height: 25px; background: ${student.rank <= 3 ? '#f39c12' : '#3498db'}; color: white; border-radius: 50%; line-height: 25px;">
                        ${student.rank}
                    </span>
                </td>
                <td style="padding: 8px;">
                    <div style="font-weight: 500;">${student.name}</div>
                    <div style="font-size: 10px; color: #666;">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${student.completedTasks}/${appData.tasks.length}</div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="font-weight: bold;">${student.totalScore}</div>
                    <div style="font-size: 10px; color: #666;">/${student.maxPossible}</div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="font-weight: bold; color: ${getPercentageColor(student.percentage)};">
                        ${student.percentage}%
                    </div>
                    <div style="font-size: 10px; color: #666;">${student.percentile} –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å</div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="width: 30px; height: 30px; background: ${gradeColor}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">
                        ${student.grade}
                    </div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="color: ${stabilityColor}; font-weight: bold;">${student.stability}</div>
                    <div style="font-size: 10px; color: #666;">–∏–∑ 100</div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <div style="font-size: 10px;">
                        <span style="color: #27ae60;">–°–∏–ª—å–Ω—ã–µ: ${student.strengths.length > 0 ? student.strengths.join(',') : '-'}</span><br>
                        <span style="color: #e74c3c;">–°–ª–∞–±—ã–µ: ${student.weaknesses.length > 0 ? student.weaknesses.join(',') : '-'}</span>
                    </div>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <button class="btn-icon small" onclick="showStudentDetails(${student.index})" title="–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑">
                        üìä
                    </button>
                    <button class="btn-icon small" onclick="generateStudentReport(${student.index})" title="–û—Ç—á–µ—Ç">
                        üìÑ
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
}

function searchStudents() {
    const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#studentsAnalysisBody tr');
    
    rows.forEach(row => {
        const studentName = row.dataset.studentName || '';
        if (studentName.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// ==================== RENDER LEVELS ANALYSIS ====================

function renderLevelsAnalysis() {
    const analysis = window.currentAnalysis || {};
    const levels = analysis.byLevel || {};
    
    let html = `
        <h4 style="margin-top: 0;">üéØ –ê–Ω–∞–ª–∏–∑ –ø–æ —É—Ä–æ–≤–Ω—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</h4>
        <p style="color: #666; margin-bottom: 15px;">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π –ø–æ —Ç–∞–∫—Å–æ–Ω–æ–º–∏–∏ –ë–ª—É–º–∞</p>
        
        <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- –ì—Ä–∞—Ñ–∏–∫ -->
            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                <h5 style="margin-top: 0;">–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ —É—Ä–æ–≤–Ω—è–º</h5>
                <div id="levelsChart" style="height: 200px; position: relative;">
    `;
    
    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    const levelData = Object.values(levels);
    if (levelData.length > 0) {
        const maxPercentage = Math.max(...levelData.map(l => parseFloat(l.avgPercentage))) || 100;
        
        levelData.forEach(level => {
            const percentage = parseFloat(level.avgPercentage);
            const barWidth = (percentage / maxPercentage * 100) + '%';
            const deviation = parseFloat(level.deviation);
            
            html += `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${level.levelName}</span>
                        <span style="font-weight: bold; color: ${level.color}">${percentage}%</span>
                    </div>
                    <div style="height: 20px; background: #f8f9fa; border-radius: 10px; overflow: hidden; position: relative;">
                        <div style="height: 100%; width: ${barWidth}; background: ${level.color}; transition: width 1s;"></div>
                        <div style="position: absolute; left: ${level.expectedPercentage / maxPercentage * 100}%; top: 0; bottom: 0; width: 2px; background: #2c3e50;"></div>
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 3px;">
                        <span>–û–∂–∏–¥–∞–ª–æ—Å—å: ${level.expectedPercentage}%</span>
                        <span style="margin-left: 10px; color: ${deviation >= 0 ? '#27ae60' : '#e74c3c'}">
                            ${deviation >= 0 ? '+' : ''}${deviation}%
                        </span>
                    </div>
                </div>
            `;
        });
    }
    
    html += `
                </div>
            </div>
            
            <!-- –õ–µ–≥–µ–Ω–¥–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h5 style="margin-top: 0;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º</h5>
                <div style="margin-top: 10px;">
    `;
    
    Object.entries(levels).forEach(([level, data]) => {
        const deviation = parseFloat(data.deviation);
        const performanceIcon = deviation >= 10 ? 'üöÄ' :
                              deviation >= 0 ? '‚úÖ' :
                              deviation >= -10 ? '‚ö†Ô∏è' : 'üîª';
        
        html += `
            <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid ${data.color};">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <span style="font-size: 20px;">${performanceIcon}</span>
                    <strong>${data.levelName}</strong>
                </div>
                <div style="font-size: 12px;">
                    <div>–ó–∞–¥–∞–Ω–∏–π: ${data.taskCount}</div>
                    <div>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${data.avgPercentage}%</div>
                    <div>–û–∂–∏–¥–∞–ª–æ—Å—å: ${data.expectedPercentage}%</div>
                    <div style="color: ${deviation >= 0 ? '#27ae60' : '#e74c3c'};">
                        –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: ${deviation >= 0 ? '+' : ''}${deviation}%
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
                </div>
            </div>
        </div>
        
        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
        <h5>üìä –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ —É—Ä–æ–≤–Ω—è–º</h5>
        <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–£—Ä–æ–≤–µ–Ω—å</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–ó–∞–¥–∞–Ω–∏–π</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–û–∂–∏–¥–∞–ª–æ—Å—å</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–°—Ç–∞—Ç—É—Å</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    Object.entries(levels).forEach(([level, data]) => {
        const deviation = parseFloat(data.deviation);
        let status = '';
        let recommendation = '';
        
        if (deviation >= 15) {
            status = '<span style="color: #27ae60;">‚úÖ –í—ã—à–µ –Ω–æ—Ä–º—ã</span>';
            recommendation = '–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è';
        } else if (deviation >= 0) {
            status = '<span style="color: #3498db;">üëç –ù–æ—Ä–º–∞</span>';
            recommendation = '–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≥—Ä—É–ø–ø–µ';
        } else if (deviation >= -15) {
            status = '<span style="color: #f39c12;">‚ö†Ô∏è –ù–∏–∂–µ –Ω–æ—Ä–º—ã</span>';
            recommendation = '–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∞';
        } else {
            status = '<span style="color: #e74c3c;">üîª –ö—Ä–∏—Ç–∏—á–Ω–æ</span>';
            recommendation = '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ–º—ã';
        }
        
        html += `
            <tr>
                <td style="padding: 8px; text-align: center;">
                    <span style="display: inline-block; padding: 5px 10px; background: ${data.color}; color: white; border-radius: 15px; font-weight: bold;">
                        ${level}. ${data.levelName}
                    </span>
                </td>
                <td style="padding: 8px; text-align: center;">${data.taskCount}</td>
                <td style="padding: 8px; text-align: center; font-weight: bold;">${data.avgPercentage}%</td>
                <td style="padding: 8px; text-align: center;">${data.expectedPercentage}%</td>
                <td style="padding: 8px; text-align: center; color: ${deviation >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: bold;">
                    ${deviation >= 0 ? '+' : ''}${deviation}%
                </td>
                <td style="padding: 8px; text-align: center;">${status}</td>
                <td style="padding: 8px; font-size: 11px;">${recommendation}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
        <div style="margin-top: 20px; padding: 15px; background: #e8f4fc; border-radius: 8px;">
            <h5 style="margin-top: 0;">üí° –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h5>
            <ul style="margin: 10px 0 0 20px; font-size: 13px;">
                <li>–ï—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ - –≥—Ä—É–ø–ø–∞ —Ö–æ—Ä–æ—à–æ —É—Å–≤–æ–∏–ª–∞ –º–∞—Ç–µ—Ä–∏–∞–ª —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è</li>
                <li>–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –±–æ–ª–µ–µ 10% —Ç—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ü–∏–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã</li>
                <li>–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–±—ä–µ–∫—Ç–∏–≤–Ω—É—é –æ—Ü–µ–Ω–∫—É</li>
                <li>–î–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –¥–æ–ª—é –∑–∞–¥–∞–Ω–∏–π 2-3 —É—Ä–æ–≤–Ω—è</li>
            </ul>
        </div>
    `;
    
    return html;
}

// ==================== RENDER ERRORS ANALYSIS ====================

function renderErrorsAnalysis() {
    const analysis = window.currentAnalysis || {};
    const errors = analysis.byErrorType || {};
    
    let html = `
        <h4 style="margin-top: 0;">üîç –ê–Ω–∞–ª–∏–∑ –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫</h4>
        <p style="color: #666; margin-bottom: 15px;">${Object.keys(errors).length} —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫, –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ –∑–∞–¥–∞–Ω–∏—è—Ö</p>
        
        <!-- –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: center;">
                <h5 style="margin-top: 0;">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫</h5>
                <div id="errorsPieChart" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                    <div style="position: relative; width: 150px; height: 150px;">
    `;
    
    // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
    const errorEntries = Object.entries(errors);
    if (errorEntries.length > 0) {
        let startAngle = 0;
        const totalTasks = errorEntries.reduce((sum, [_, data]) => sum + data.count, 0);
        
        errorEntries.forEach(([errorKey, data], index) => {
            const percentage = (data.count / totalTasks * 100).toFixed(1);
            const angle = (data.count / totalTasks * 360).toFixed(1);
            
            html += `
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                    <div style="position: absolute; top: 50%; left: 50%; width: 150px; height: 150px; border-radius: 50%; 
                          background: conic-gradient(${data.color} ${startAngle}deg ${parseFloat(startAngle) + parseFloat(angle)}deg, transparent ${parseFloat(startAngle) + parseFloat(angle)}deg); 
                          transform: translate(-50%, -50%) rotate(-90deg);">
                    </div>
                </div>
            `;
            
            startAngle += parseFloat(angle);
        });
        
        // –¶–µ–Ω—Ç—Ä
        html += `
                        <div style="position: absolute; top: 50%; left: 50%; width: 70px; height: 70px; background: white; border-radius: 50%; transform: translate(-50%, -50%);"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${totalTasks}</div>
                            <div style="font-size: 10px; color: #666;">–∑–∞–¥–∞–Ω–∏–π</div>
                        </div>
        `;
    } else {
        html += `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫
            </div>
        `;
    }
    
    html += `
                    </div>
                </div>
            </div>
            
            <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h5 style="margin-top: 0;">–¢–∏–ø—ã –æ—à–∏–±–æ–∫</h5>
                <div style="margin-top: 10px; max-height: 180px; overflow-y: auto;">
    `;
    
    errorEntries.forEach(([errorKey, data]) => {
        const percentage = (data.count / appData.tasks.length * 100).toFixed(1);
        
        html += `
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #eee;">
                <div style="width: 15px; height: 15px; background: ${data.color}; border-radius: 3px;"></div>
                <div style="flex: 1; font-size: 13px;">
                    <div style="font-weight: 500;">${data.name}</div>
                    <div style="font-size: 11px; color: #666;">
                        ${data.count} –∑–∞–¥–∞–Ω–∏–π (${percentage}%) | ${data.percentage}% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                    </div>
                </div>
                <div style="font-size: 12px; font-weight: bold; color: ${parseFloat(data.percentage) >= 50 ? '#27ae60' : '#e74c3c'}">
                    ${data.percentage}%
                </div>
            </div>
        `;
    });
    
    html += `
                </div>
            </div>
        </div>
        
        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
        <h5>üìä –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫</h5>
        <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="padding: 10px; background: #f8f9fa;">–¢–∏–ø –æ—à–∏–±–∫–∏</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–ó–∞–¥–∞–Ω–∏–π</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–£—á–∞—â–∏—Ö—Å—è</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–°—Ä. –±–∞–ª–ª/—É—á</th>
                        <th style="padding: 10px; background: #f8f9fa; text-align: center;">–°—Ç–∞—Ç—É—Å</th>
                        <th style="padding: 10px; background: #f8f9fa;">–ó–∞–¥–∞–Ω–∏—è</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    errorEntries.forEach(([errorKey, data]) => {
        const percentage = parseFloat(data.percentage);
        let status = '';
        
        if (percentage >= 70) {
            status = '<span style="color: #27ae60;">‚úÖ –•–æ—Ä–æ—à–æ</span>';
        } else if (percentage >= 50) {
            status = '<span style="color: #3498db;">‚ö†Ô∏è –°—Ä–µ–¥–Ω–µ</span>';
        } else if (percentage >= 30) {
            status = '<span style="color: #f39c12;">üîª –ü—Ä–æ–±–ª–µ–º–Ω–æ</span>';
        } else {
            status = '<span style="color: #e74c3c;">üö® –ö—Ä–∏—Ç–∏—á–Ω–æ</span>';
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π
        const taskNumbers = data.tasks.map(t => t.number).slice(0, 3);
        const tasksText = taskNumbers.length > 0 ? 
            `–ó–∞–¥–∞–Ω–∏—è: ${taskNumbers.join(', ')}${data.tasks.length > 3 ? '...' : ''}` : 
            '–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π';
        
        html += `
            <tr>
                <td style="padding: 8px;">
                    <span style="display: inline-block; width: 12px; height: 12px; background: ${data.color}; border-radius: 2px; margin-right: 8px;"></span>
                    ${data.name}
                </td>
                <td style="padding: 8px; text-align: center; font-weight: bold;">${data.count}</td>
                <td style="padding: 8px; text-align: center;">${data.studentCount}</td>
                <td style="padding: 8px; text-align: center; font-weight: bold; color: ${percentage >= 50 ? '#27ae60' : '#e74c3c'}">
                    ${data.percentage}%
                </td>
                <td style="padding: 8px; text-align: center;">${data.avgPerStudent}</td>
                <td style="padding: 8px; text-align: center;">${status}</td>
                <td style="padding: 8px; font-size: 11px;">${tasksText}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
        <div style="margin-top: 20px; padding: 15px; background: ${errorEntries.length > 0 ? '#fff8e1' : '#e8f4fc'}; border-radius: 8px;">
            <h5 style="margin-top: 0;">üí° –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h5>
            <ul style="margin: 10px 0 0 20px; font-size: 13px;">
    `;
    
    if (errorEntries.length === 0) {
        html += `
                <li>–¢–∏–ø—ã –æ—à–∏–±–æ–∫ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ –∑–∞–¥–∞–Ω–∏—è—Ö</li>
                <li>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–µ "–¢–∏–ø –æ—à–∏–±–∫–∏" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</li>
                <li>–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø—Ä–æ–≤–æ–¥–∏—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏–π —É—á–∞—â–∏—Ö—Å—è</li>
        `;
    } else {
        const worstError = errorEntries.sort((a, b) => a[1].percentage - b[1].percentage)[0];
        const bestError = errorEntries.sort((a, b) => b[1].percentage - a[1].percentage)[0];
        
        html += `
                <li>–ù–∞–∏–±–æ–ª–µ–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Ç–∏–ø: <strong>${worstError[1].name}</strong> (${worstError[1].percentage}%)</li>
                <li>–õ—É—á—à–µ –≤—Å–µ–≥–æ —É—Å–≤–æ–µ–Ω: <strong>${bestError[1].name}</strong> (${bestError[1].percentage}%)</li>
                <li>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–∏–º–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è</li>
        `;
    }
    
    html += `
            </ul>
        </div>
    `;
    
    return html;
}

function renderCorrelationsAnalysis() {
    const analysis = window.currentAnalysis || {};
    const correlations = analysis.correlations || [];
    
    let html = `
        <h4 style="margin-top: 0;">üîó –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h4>
        <p style="color: #666; margin-bottom: 15px;">
            –ê–Ω–∞–ª–∏–∑ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π –º–µ–∂–¥—É –∑–∞–¥–∞–Ω–∏—è–º–∏. 
            –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å—Ö–æ–¥–Ω—ã–º –æ–±—Ä–∞–∑–æ–º.
            –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –æ–±—Ä–∞—Ç–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å.
        </p>
        
        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
            <div>
                <div style="font-size: 11px; color: #666; margin-bottom: 10px;">
                    –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (|r| > 0.5)
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="padding: 10px; background: #f8f9fa; text-align: center;">–ó–∞–¥–∞–Ω–∏–µ 1</th>
                                <th style="padding: 10px; background: #f8f9fa; text-align: center;">–ó–∞–¥–∞–Ω–∏–µ 2</th>
                                <th style="padding: 10px; background: #f8f9fa; text-align: center;">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (r)</th>
                                <th style="padding: 10px; background: #f8f9fa; text-align: center;">–°–∏–ª–∞ —Å–≤—è–∑–∏</th>
                                <th style="padding: 10px; background: #f8f9fa; text-align: center;">–¢–∏–ø</th>
                                <th style="padding: 10px; background: #f8f9fa; text-align: center;">–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    if (correlations.length === 0) {
        html += `
            <tr>
                <td colspan="6" style="padding: 30px; text-align: center; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                    <div>–ù–µ—Ç –∑–Ω–∞—á–∏–º—ã—Ö –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π –º–µ–∂–¥—É –∑–∞–¥–∞–Ω–∏—è–º–∏</div>
                    <div style="font-size: 11px; margin-top: 5px;">
                        (–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –æ–±–Ω–∞—Ä—É–∂–∞—Ç—Å—è –ø—Ä–∏ |r| > 0.5)
                    </div>
                </td>
            </tr>
        `;
    } else {
        correlations.forEach((corr, index) => {
            // –ü–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π
            const task1 = appData.tasks[corr.task1 - 1];
            const task2 = appData.tasks[corr.task2 - 1];
            
            const task1Desc = task1?.description ? 
                task1.description.substring(0, 30) + (task1.description.length > 30 ? '...' : '') : 
                `–ó–∞–¥–∞–Ω–∏–µ ${corr.task1}`;
                
            const task2Desc = task2?.description ? 
                task2.description.substring(0, 30) + (task2.description.length > 30 ? '...' : '') : 
                `–ó–∞–¥–∞–Ω–∏–µ ${corr.task2}`;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏ –∏–∫–æ–Ω–∫—É
            let color, icon, interpretation;
            const r = parseFloat(corr.correlation);
            
            if (r > 0.7) {
                color = '#27ae60';
                icon = '‚ÜóÔ∏è';
                interpretation = '–°–∏–ª—å–Ω–∞—è –ø—Ä—è–º–∞—è —Å–≤—è–∑—å';
            } else if (r > 0.5) {
                color = '#3498db';
                icon = '‚ÜóÔ∏è';
                interpretation = '–£–º–µ—Ä–µ–Ω–Ω–∞—è –ø—Ä—è–º–∞—è —Å–≤—è–∑—å';
            } else if (r < -0.7) {
                color = '#e74c3c';
                icon = '‚ÜòÔ∏è';
                interpretation = '–°–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å';
            } else if (r < -0.5) {
                color = '#f39c12';
                icon = '‚ÜòÔ∏è';
                interpretation = '–£–º–µ—Ä–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å';
            }
            
            html += `
                <tr style="${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                    <td style="padding: 8px; text-align: center;">
                        <div style="font-weight: bold;">${corr.task1}</div>
                        <div style="font-size: 10px; color: #666;">${task1Desc}</div>
                    </td>
                    <td style="padding: 8px; text-align: center;">
                        <div style="font-weight: bold;">${corr.task2}</div>
                        <div style="font-size: 10px; color: #666;">${task2Desc}</div>
                    </td>
                    <td style="padding: 8px; text-align: center;">
                        <div style="font-weight: bold; color: ${color}; font-size: 14px;">
                            ${icon} ${corr.correlation}
                        </div>
                    </td>
                    <td style="padding: 8px; text-align: center;">
                        <span style="display: inline-block; padding: 3px 8px; background: ${color}; color: white; border-radius: 10px; font-size: 11px;">
                            ${corr.strength === 'strong' ? '–°–∏–ª—å–Ω–∞—è' : 
                              corr.strength === 'moderate' ? '–£–º–µ—Ä–µ–Ω–Ω–∞—è' : '–°–ª–∞–±–∞—è'}
                        </span>
                    </td>
                    <td style="padding: 8px; text-align: center;">
                        <span style="color: ${corr.type === 'positive' ? '#27ae60' : '#e74c3c'}">
                            ${corr.type === 'positive' ? '–ü—Ä—è–º–∞—è' : '–û–±—Ä–∞—Ç–Ω–∞—è'}
                        </span>
                    </td>
                    <td style="padding: 8px; font-size: 11px;">
                        ${interpretation}
                    </td>
                </tr>
            `;
        });
    }
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏ -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; height: fit-content;">
                <h5 style="margin-top: 0;">üìñ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π</h5>
                
                <div style="margin-bottom: 15px;">
                    <strong>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ü–∏—Ä—Å–æ–Ω–∞ (r):</strong>
                    <ul style="font-size: 11px; margin: 5px 0 0 15px; color: #666;">
                        <li>+1.0: –∏–¥–µ–∞–ª—å–Ω–∞—è –ø—Ä—è–º–∞—è —Å–≤—è–∑—å</li>
                        <li>+0.7 –¥–æ +1.0: —Å–∏–ª—å–Ω–∞—è –ø—Ä—è–º–∞—è —Å–≤—è–∑—å</li>
                        <li>+0.5 –¥–æ +0.7: —É–º–µ—Ä–µ–Ω–Ω–∞—è –ø—Ä—è–º–∞—è —Å–≤—è–∑—å</li>
                        <li>+0.3 –¥–æ +0.5: —Å–ª–∞–±–∞—è –ø—Ä—è–º–∞—è —Å–≤—è–∑—å</li>
                        <li>0.0 –¥–æ ¬±0.3: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–≤—è–∑–∏</li>
                        <li>-0.3 –¥–æ -0.5: —Å–ª–∞–±–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</li>
                        <li>-0.5 –¥–æ -0.7: —É–º–µ—Ä–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</li>
                        <li>-0.7 –¥–æ -1.0: —Å–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</li>
                        <li>-1.0: –∏–¥–µ–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</li>
                    </ul>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>üìà –ü—Ä—è–º–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è (r > 0):</strong>
                    <p style="font-size: 11px; margin: 5px 0; color: #666;">
                        –£—á–∞—â–∏–µ—Å—è, —Ö–æ—Ä–æ—à–æ –≤—ã–ø–æ–ª–Ω–∏–≤—à–∏–µ –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ, 
                        —Ç–∞–∫–∂–µ —Ö–æ—Ä–æ—à–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç –¥—Ä—É–≥–æ–µ. –ú–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Å—Ö–æ–∂–∏–µ 
                        –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —É–º–µ–Ω–∏—è –∏–ª–∏ –æ–±—â—É—é —Ç–µ–º—É.
                    </p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>üìâ –û–±—Ä–∞—Ç–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è (r < 0):</strong>
                    <p style="font-size: 11px; margin: 5px 0; color: #666;">
                        –£—á–∞—â–∏–µ—Å—è, —Ö–æ—Ä–æ—à–æ –≤—ã–ø–æ–ª–Ω–∏–≤—à–∏–µ –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ, 
                        –ø–ª–æ—Ö–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç –¥—Ä—É–≥–æ–µ. –ú–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Ä–∞–∑–Ω—ã–µ 
                        —Ç–∏–ø—ã –º—ã—à–ª–µ–Ω–∏—è –∏–ª–∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
                    </p>
                </div>
                
                <div>
                    <strong>üéØ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:</strong>
                    <p style="font-size: 11px; margin: 5px 0; color: #666;">
                        ‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π-–¥—É–±–ª–∏–∫–∞—Ç–æ–≤<br>
                        ‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—â–∏—Ö –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω<br>
                        ‚Ä¢ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞<br>
                        ‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–∞–±–æ—Ç—ã
                    </p>
                </div>
            </div>
        </div>
        
        <!-- –ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) -->
        ${correlations.length > 0 ? `
            <div style="margin-top: 20px;">
                <h5>üìä –ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)</h5>
                <div style="overflow-x: auto;">
                    <div style="display: inline-block; padding: 10px; background: white; border-radius: 5px;">
                        ${renderCorrelationMatrix(6)} <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 6x6 –º–∞—Ç—Ä–∏—Ü—É -->
                    </div>
                </div>
            </div>
        ` : ''}
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="btn btn-sm btn-outline" onclick="showDetailedCorrelationAnalysis()">
                üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
            </button>
            <button class="btn btn-sm btn-outline" onclick="exportCorrelationMatrix()">
                üì• –≠–∫—Å–ø–æ—Ä—Ç –º–∞—Ç—Ä–∏—Ü—ã
            </button>
        </div>
    `;
    
    return html;
}

function renderCorrelationMatrix(size = 6) {
    const tasksCount = Math.min(size, appData.tasks.length);
    let html = '<table style="border-collapse: collapse; font-size: 10px;">';
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    html += '<tr><th style="padding: 5px; background: #f8f9fa; min-width: 30px;"></th>';
    for (let i = 0; i < tasksCount; i++) {
        html += `<th style="padding: 5px; background: #f8f9fa; text-align: center; min-width: 30px;">${i + 1}</th>`;
    }
    html += '</tr>';
    
    // –î–∞–Ω–Ω—ã–µ
    for (let i = 0; i < tasksCount; i++) {
        html += `<tr><td style="padding: 5px; background: #f8f9fa; font-weight: bold; text-align: center;">${i + 1}</td>`;
        
        for (let j = 0; j < tasksCount; j++) {
            if (i === j) {
                html += '<td style="padding: 5px; text-align: center; background: #f8f9fa;">1.0</td>';
            } else {
                // –ù–∞—Ö–æ–¥–∏–º –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –º–µ–∂–¥—É –∑–∞–¥–∞–Ω–∏—è–º–∏ i+1 –∏ j+1
                const correlation = findCorrelationValue(i + 1, j + 1);
                const color = getCorrelationColor(correlation);
                
                html += `
                    <td style="padding: 5px; text-align: center; background: ${color}; color: ${Math.abs(correlation) > 0.5 ? 'white' : '#333'};">
                        ${correlation.toFixed(2)}
                    </td>
                `;
            }
        }
        html += '</tr>';
    }
    
    html += '</table>';
    return html;
}

function findCorrelationValue(task1, task2) {
    const analysis = window.currentAnalysis || {};
    const correlations = analysis.correlations || [];
    
    const found = correlations.find(corr => 
        (corr.task1 === task1 && corr.task2 === task2) ||
        (corr.task1 === task2 && corr.task2 === task1)
    );
    
    return found ? parseFloat(found.correlation) : 0;
}

function getCorrelationColor(correlation) {
    const absCorr = Math.abs(correlation);
    
    if (absCorr > 0.7) return correlation > 0 ? '#27ae60' : '#e74c3c';
    if (absCorr > 0.5) return correlation > 0 ? '#7bed9f' : '#ff6b81';
    if (absCorr > 0.3) return correlation > 0 ? '#d1f2eb' : '#ffcccc';
    return '#f8f9fa';
}

function exportAnalysisReport(analysis) {
    console.log('üì§ –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞...');
    
    const report = {
        metadata: {
            generated: new Date().toISOString(),
            system: '–ê–Ω–∞–ª–∏–∑ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤',
            version: '1.0',
            subject: appData.test.subject,
            class: appData.test.class,
            theme: appData.test.theme,
            workType: appData.test.workType,
            date: appData.test.testDate
        },
        summary: analysis.summary,
        tasksAnalysis: analysis.byTask,
        studentsAnalysis: analysis.byStudent,
        levelsAnalysis: analysis.byLevel,
        errorsAnalysis: analysis.byErrorType,
        correlations: analysis.correlations,
        insights: analysis.insights,
        recommendations: generateDetailedRecommendations(analysis)
    };
    
    const dataStr = JSON.stringify(report, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    
    const fileName = `–ê–Ω–∞–ª–∏–∑_${appData.test.subject || '—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'}_${appData.test.class || '–∫–ª–∞—Å—Å'}_${new Date().toLocaleDateString('ru-RU')}.json`;
    
    const link = document.createElement('a');
    link.href = dataUri;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification(`‚úÖ –û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω (${(dataStr.length / 1024).toFixed(1)} –ö–ë)`, 'success');
}

function generateDetailedRecommendations(analysis) {
    const recommendations = [];
    
    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    if (analysis.summary.completionRate < 70) {
        recommendations.push({
            type: 'completion',
            priority: 'high',
            title: '–ù–∏–∑–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã',
            description: `–¢–æ–ª—å–∫–æ ${analysis.summary.completionRate}% —É—á–∞—â–∏—Ö—Å—è –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è`,
            actions: [
                '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',
                '–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å—Ä–æ–∫–æ–≤',
                '–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏'
            ]
        });
    }
    
    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º
    const criticalTasks = analysis.byTask.filter(task => task.zone === 'critical');
    if (criticalTasks.length > 0) {
        recommendations.push({
            type: 'tasks',
            priority: 'high',
            title: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è',
            description: `${criticalTasks.length} –∑–∞–¥–∞–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –º–µ–Ω–µ–µ —á–µ–º –Ω–∞ 20%`,
            actions: [
                `–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–¥–∞–Ω–∏—è: ${criticalTasks.map(t => t.number).join(', ')}`,
                '–ü–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–µ–º—ã',
                '–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã'
            ]
        });
    }
    
    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    Object.entries(analysis.byLevel).forEach(([level, data]) => {
        if (data.deviation < -10) {
            recommendations.push({
                type: 'levels',
                priority: 'medium',
                title: `–°–ª–∞–±—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ ${data.levelName}`,
                description: `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ ${data.percentage}% –ø—Ä–∏ –æ–∂–∏–¥–∞–µ–º—ã—Ö ${data.expectedPercentage}%`,
                actions: [
                    `–£–¥–µ–ª–∏—Ç—å –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è–º —É—Ä–æ–≤–Ω—è ${level}`,
                    '–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è',
                    '–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø–æ–≤—É—é —Ä–∞–±–æ—Ç—É –ø–æ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ'
                ]
            });
        }
    });
    
    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫
    const weakErrorTypes = Object.entries(analysis.byErrorType)
        .filter(([_, data]) => data.percentage < 50);
    
    if (weakErrorTypes.length > 0) {
        const worst = weakErrorTypes.sort((a, b) => a[1].percentage - b[1].percentage)[0];
        recommendations.push({
            type: 'errors',
            priority: 'medium',
            title: '–ü—Ä–æ–±–ª–µ–º–Ω—ã–π —Ç–∏–ø –æ—à–∏–±–æ–∫',
            description: `–ù–∏–∑–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ —Ç–∏–ø—É "${worst[1].name}"`,
            actions: [
                `–ü—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è –ø–æ —Ç–µ–º–µ "${worst[1].name}"`,
                '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏',
                '–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è'
            ]
        });
    }
    
    // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    const excellentTasks = analysis.byTask.filter(task => task.zone === 'excellent');
    if (excellentTasks.length > appData.tasks.length * 0.3) {
        recommendations.push({
            type: 'positive',
            priority: 'low',
            title: '–•–æ—Ä–æ—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã',
            description: '–ì—Ä—É–ø–ø–∞ —Ö–æ—Ä–æ—à–æ —É—Å–≤–æ–∏–ª–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã',
            actions: [
                '–ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–º —Ç–µ–º–∞–º',
                '–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç–Ω—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
                '–ü—Ä–∏–≤–ª–µ—á—å —É—Å–ø–µ—à–Ω—ã—Ö —É—á–∞—â–∏—Ö—Å—è –∫ –ø–æ–º–æ—â–∏ –æ—Ç—Å—Ç–∞—é—â–∏–º'
            ]
        });
    }
    
    return recommendations;
}

function printAnalysisReport(analysis) {
    console.log('üñ®Ô∏è –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞...');
    
    const printWindow = window.open('', '_blank');
    const date = new Date().toLocaleDateString('ru-RU');
    
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç</title>
            <meta charset="UTF-8">
            <style>
                @page {
                    size: A4;
                    margin: 20mm;
                }
                
                body {
                    font-family: 'Arial', sans-serif;
                    margin: 0;
                    padding: 0;
                    color: #333;
                    font-size: 11pt;
                    line-height: 1.5;
                }
                
                .header {
                    text-align: center;
                    margin-bottom: 20px;
                    padding-bottom: 15px;
                    border-bottom: 2px solid #3498db;
                }
                
                .header h1 {
                    color: #2c3e50;
                    margin: 0 0 10px 0;
                    font-size: 18pt;
                }
                
                .metadata {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 10px;
                    margin-bottom: 25px;
                    font-size: 10pt;
                }
                
                .section {
                    margin-bottom: 25px;
                    page-break-inside: avoid;
                }
                
                .section-title {
                    background: #f8f9fa;
                    padding: 8px 12px;
                    border-left: 4px solid #3498db;
                    margin: 0 0 15px 0;
                    font-size: 14pt;
                }
                
                .summary-cards {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 15px;
                    margin-bottom: 20px;
                }
                
                .card {
                    text-align: center;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #e9ecef;
                }
                
                .card-value {
                    font-size: 20pt;
                    font-weight: bold;
                    margin: 10px 0;
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 15px 0;
                    font-size: 9pt;
                }
                
                th {
                    background: #f8f9fa;
                    padding: 8px;
                    text-align: left;
                    border: 1px solid #dee2e6;
                    font-weight: 600;
                }
                
                td {
                    padding: 8px;
                    border: 1px solid #dee2e6;
                }
                
                .insight {
                    margin: 10px 0;
                    padding: 10px;
                    border-left: 4px solid;
                    background: #f8f9fa;
                }
                
                .insight-warning { border-color: #f39c12; }
                .insight-danger { border-color: #e74c3c; }
                .insight-success { border-color: #27ae60; }
                .insight-info { border-color: #3498db; }
                
                .recommendation {
                    margin: 15px 0;
                    padding: 12px;
                    background: #e8f4fc;
                    border-radius: 5px;
                }
                
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #dee2e6;
                    font-size: 9pt;
                    color: #666;
                    text-align: center;
                }
                
                @media print {
                    .no-print { display: none; }
                    .page-break { page-break-before: always; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Ä–∞–±–æ—Ç—ã</h1>
                <div style="color: #666;">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${date}</div>
            </div>
            
            <div class="metadata">
                <div><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong> ${appData.test.subject || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                <div><strong>–ö–ª–∞—Å—Å:</strong> ${appData.test.class || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                <div><strong>–¢–µ–º–∞:</strong> ${appData.test.theme || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                <div><strong>–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</strong> ${workTypes[appData.test.workType]?.name || appData.test.workType || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                <div><strong>–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</strong> ${appData.test.testDate || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                <div><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—â–∏—Ö—Å—è:</strong> ${analysis.summary.totalStudents}</div>
                <div><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π:</strong> ${analysis.summary.totalTasks}</div>
                <div><strong>–ú–∞–∫—Å. –±–∞–ª–ª:</strong> ${analysis.summary.maxTotalScore}</div>
            </div>
            
            <div class="section">
                <h2 class="section-title">üìà –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
                
                <div class="summary-cards">
                    <div class="card">
                        <div>–°—Ä–µ–¥–Ω–∏–π %</div>
                        <div class="card-value" style="color: #3498db;">${analysis.summary.avgPercentage}%</div>
                        <div>–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                    </div>
                    
                    <div class="card">
                        <div>–°—Ä–µ–¥–Ω—è—è</div>
                        <div class="card-value" style="color: #2ecc71;">${analysis.summary.avgGrade}</div>
                        <div>–æ—Ü–µ–Ω–∫–∞</div>
                    </div>
                    
                    <div class="card">
                        <div>–í—ã–ø–æ–ª–Ω–∏–ª–∏</div>
                        <div class="card-value" style="color: #f39c12;">${analysis.summary.completionRate}%</div>
                        <div>–≤—Å–µ –∑–∞–¥–∞–Ω–∏—è</div>
                    </div>
                    
                    <div class="card">
                        <div>–†–∞–∑–±—Ä–æ—Å</div>
                        <div class="card-value" style="color: #e74c3c;">${analysis.summary.stdDev}</div>
                        <div>(œÉ)</div>
                    </div>
                </div>
                
                <div style="font-size: 10pt; color: #666;">
                    <strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong>
                    –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: ${analysis.summary.minScore} | 
                    –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: ${analysis.summary.maxScore} | 
                    –†–∞–∑–º–∞—Ö: ${analysis.summary.scoreRange} | 
                    –ú–µ–¥–∏–∞–Ω–∞: ${analysis.summary.medianScore}
                </div>
            </div>
    `;
    
    // –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã
    if (analysis.insights && analysis.insights.length > 0) {
        html += `
            <div class="section">
                <h2 class="section-title">üí° –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã</h2>
        `;
        
        analysis.insights.forEach(insight => {
            const insightClass = insight.type === 'danger' ? 'insight-danger' :
                               insight.type === 'warning' ? 'insight-warning' :
                               insight.type === 'info' ? 'insight-info' : 'insight-success';
            
            html += `
                <div class="insight ${insightClass}">
                    <div style="font-weight: bold; margin-bottom: 5px;">${insight.title}</div>
                    <div style="margin-bottom: 5px;">${insight.message}</div>
                    <div style="font-size: 9pt; color: #666;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${insight.suggestion}</div>
                </div>
            `;
        });
        
        html += `</div>`;
    }
    
    // –ê–Ω–∞–ª–∏–∑ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º (—Ç–æ–ø-10)
    if (analysis.byTask && analysis.byTask.length > 0) {
        html += `
            <div class="section page-break">
                <h2 class="section-title">üìù –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π (–¢–û–ü-10)</h2>
                
                <table>
                    <thead>
                        <tr>
                            <th>‚Ññ</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–£—Ä–æ–≤–µ–Ω—å</th>
                            <th>% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
                            <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                            <th>–ó–æ–Ω–∞</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        analysis.byTask
            .sort((a, b) => a.percentage - b.percentage)
            .slice(0, 10)
            .forEach(task => {
                const zoneColor = task.zone === 'excellent' ? '#27ae60' :
                                 task.zone === 'good' ? '#3498db' :
                                 task.zone === 'average' ? '#f39c12' :
                                 task.zone === 'weak' ? '#e67e22' : '#e74c3c';
                
                html += `
                    <tr>
                        <td>${task.number}</td>
                        <td>${task.description.substring(0, 40)}${task.description.length > 40 ? '...' : ''}</td>
                        <td>${task.level}</td>
                        <td style="font-weight: bold; color: ${zoneColor};">${task.percentage}%</td>
                        <td>${task.difficulty}</td>
                        <td style="color: ${zoneColor}; font-weight: bold;">
                            ${task.zone === 'excellent' ? '–û—Ç–ª–∏—á–Ω–æ' :
                              task.zone === 'good' ? '–•–æ—Ä–æ—à–æ' :
                              task.zone === 'average' ? '–°—Ä–µ–¥–Ω–µ' :
                              task.zone === 'weak' ? '–°–ª–∞–±–æ' : '–ö—Ä–∏—Ç–∏—á–Ω–æ'}
                        </td>
                    </tr>
                `;
            });
        
        html += `
                    </tbody>
                </table>
                
                <div style="font-size: 9pt; color: #666; margin-top: 10px;">
                    * –°–ª–æ–∂–Ω–æ—Å—Ç—å: —á–µ–º –≤—ã—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ (100 - % –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
                </div>
            </div>
        `;
    }
    
    // –ê–Ω–∞–ª–∏–∑ –ø–æ —É—á–∞—â–∏–º—Å—è (—Ç–æ–ø-5)
    if (analysis.byStudent && analysis.byStudent.length > 0) {
        html += `
            <div class="section">
                <h2 class="section-title">üë• –†–µ–π—Ç–∏–Ω–≥ —É—á–∞—â–∏—Ö—Å—è (–¢–û–ü-5)</h2>
                
                <table>
                    <thead>
                        <tr>
                            <th>–ú–µ—Å—Ç–æ</th>
                            <th>–£—á–∞—â–∏–π—Å—è</th>
                            <th>–ë–∞–ª–ª—ã</th>
                            <th>%</th>
                            <th>–û—Ü–µ–Ω–∫–∞</th>
                            <th>–†–µ–π—Ç–∏–Ω–≥</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        analysis.byStudent
            .slice(0, 5)
            .forEach(student => {
                html += `
                    <tr>
                        <td>${student.rank}</td>
                        <td>${student.name}</td>
                        <td>${student.totalScore}/${student.maxPossible}</td>
                        <td>${student.percentage}%</td>
                        <td>${student.grade}</td>
                        <td>${student.percentile}%</td>
                    </tr>
                `;
            });
        
        html += `
                    </tbody>
                </table>
                
                <div style="font-size: 9pt; color: #666; margin-top: 10px;">
                    * –†–µ–π—Ç–∏–Ω–≥: –ø—Ä–æ—Ü–µ–Ω—Ç —É—á–∞—â–∏—Ö—Å—è, –∫–æ—Ç–æ—Ä—ã—Ö –¥–∞–Ω–Ω—ã–π —É—á–µ–Ω–∏–∫ –æ–ø–µ—Ä–µ–∂–∞–µ—Ç
                </div>
            </div>
        `;
    }
    
    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    const recommendations = generateDetailedRecommendations(analysis);
    if (recommendations.length > 0) {
        html += `
            <div class="section page-break">
                <h2 class="section-title">üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É—á–∏—Ç–µ–ª—è</h2>
        `;
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
        const highPriority = recommendations.filter(r => r.priority === 'high');
        const mediumPriority = recommendations.filter(r => r.priority === 'medium');
        const lowPriority = recommendations.filter(r => r.priority === 'low');
        
        const renderPriority = (priority, title) => {
            if (priority.length === 0) return '';
            
            return `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: ${title === '–í—ã—Å–æ–∫–∏–π' ? '#e74c3c' : 
                                     title === '–°—Ä–µ–¥–Ω–∏–π' ? '#f39c12' : '#27ae60'};
                           margin: 0 0 10px 0;">
                        ${title} –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                    </h3>
                    ${priority.map(rec => `
                        <div class="recommendation">
                            <div style="font-weight: bold; margin-bottom: 8px;">${rec.title}</div>
                            <div style="margin-bottom: 8px;">${rec.description}</div>
                            <div style="font-size: 9pt;">
                                <strong>–î–µ–π—Å—Ç–≤–∏—è:</strong>
                                <ul style="margin: 5px 0 0 20px;">
                                    ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        };
        
        html += renderPriority(highPriority, '–í—ã—Å–æ–∫–∏–π');
        html += renderPriority(mediumPriority, '–°—Ä–µ–¥–Ω–∏–π');
        html += renderPriority(lowPriority, '–ù–∏–∑–∫–∏–π');
        
        html += `</div>`;
    }
    
    // –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (analysis.correlations && analysis.correlations.length > 0) {
        html += `
            <div class="section">
                <h2 class="section-title">üîó –ó–Ω–∞—á–∏–º—ã–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏</h2>
                
                <div style="font-size: 9pt; color: #666; margin-bottom: 10px;">
                    –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º |r| > 0.5
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>–ó–∞–¥–∞–Ω–∏–µ 1</th>
                            <th>–ó–∞–¥–∞–Ω–∏–µ 2</th>
                            <th>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (r)</th>
                            <th>–°–∏–ª–∞ —Å–≤—è–∑–∏</th>
                            <th>–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        analysis.correlations
            .slice(0, 5)
            .forEach(corr => {
                const strength = corr.strength === 'strong' ? '–°–∏–ª—å–Ω–∞—è' :
                               corr.strength === 'moderate' ? '–£–º–µ—Ä–µ–Ω–Ω–∞—è' : '–°–ª–∞–±–∞—è';
                
                const interpretation = corr.type === 'positive' ? 
                    '–ü—Ä—è–º–∞—è —Å–≤—è–∑—å (–∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å—Ö–æ–¥–Ω–æ)' :
                    '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (–æ–±—Ä–∞—Ç–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)';
                
                html += `
                    <tr>
                        <td>${corr.task1}</td>
                        <td>${corr.task2}</td>
                        <td style="font-weight: bold; color: ${corr.type === 'positive' ? '#27ae60' : '#e74c3c'}">
                            ${corr.correlation}
                        </td>
                        <td>${strength}</td>
                        <td>${interpretation}</td>
                    </tr>
                `;
            });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    // –ü–æ–¥–≤–∞–ª
    html += `
            <div class="footer">
                <div>–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–∏—Å—Ç–µ–º–æ–π "–ê–Ω–∞–ª–∏–∑ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"</div>
                <div>–î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${new Date().toLocaleString('ru-RU')}</div>
                <div style="margin-top: 10px;">
                    <button class="no-print" onclick="window.print()" 
                            style="padding: 8px 16px; background: #3498db; color: white; 
                                   border: none; border-radius: 4px; cursor: pointer;">
                        üñ®Ô∏è –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞
                    </button>
                </div>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ 500–º—Å
    setTimeout(() => {
        printWindow.print();
    }, 500);
    
    showNotification('üñ®Ô∏è –û—Ç—á–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è –ø–µ—á–∞—Ç–∏', 'info');
}