/**
 * üõ°Ô∏è –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
 * –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
 * –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —à—É–º–Ω—ã—Ö –æ—à–∏–±–æ–∫
 */

class ErrorHandler {
  constructor() {
    this.errorTypes = {
      VALIDATION: 'VALIDATION_ERROR',
      NETWORK: 'NETWORK_ERROR',

      PARSING: 'PARSING_ERROR',
      RUNTIME: 'RUNTIME_ERROR',
      UNKNOWN: 'UNKNOWN_ERROR',
      CORS: 'CORS_ERROR'
    };
    
    // –®–∞–±–ª–æ–Ω—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —à—É–º–Ω—ã—Ö –æ—à–∏–±–æ–∫
    this.noisyErrorPatterns = [
      // –û—à–∏–±–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π Chrome
      /^Unchecked runtime\.lastError/,
      /^The message port closed before/,
      /^A listener indicated an asynchronous response/,
      /^Extension context invalidated/,
      
      // –û—à–∏–±–∫–∏ CORS –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å file://
      /^Access to fetch at 'file:\/\//,
      /Cross origin requests are only supported/,
      /from origin 'null' has been blocked by CORS policy/,
      
      // –ë–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏ —Ä–µ–∫–ª–∞–º—ã/—Ç—Ä–µ–∫–µ—Ä–æ–≤
      /gtmpx\.com/,
      /googlesyndication/,
      /doubleclick/,
      /analytics/,
      /tracking/,
      
      // Service Worker –æ—à–∏–±–∫–∏ –≤ file://
      /ServiceWorker.*The URL protocol.*not supported/,
      /Failed to register a ServiceWorker/
    ];
    
    // –§–ª–∞–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    this.debugMode = false;
    
    this.init();
  }

  init() {
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    window.addEventListener('error', (event) => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—à–∏–±–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏
      if (this.isNoisyError(event.error || event.message)) {
        if (this.debugMode) {
          console.log('[Filtered noisy error]:', event.error?.message || event.message);
        }
        return;
      }
      this.handleGlobalError(event.error || event.message);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
    window.addEventListener('unhandledrejection', (event) => {
      const reason = event.reason;
      if (this.isNoisyError(reason?.message || reason)) {
        if (this.debugMode) {
          console.log('[Filtered noisy promise rejection]:', reason?.message || reason);
        }
        return;
      }
      this.handlePromiseRejection(reason);
    });
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ "—à—É–º–Ω–æ–π"
   */
  isNoisyError(error) {
    const errorMessage = typeof error === 'string' 
      ? error 
      : error?.message || error?.toString() || '';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —à–∞–±–ª–æ–Ω–∞–º
    return this.noisyErrorPatterns.some(pattern => pattern.test(errorMessage));
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
   */
  handle(error, context = 'Unknown', metadata = {}) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —à—É–º–Ω—ã–µ –æ—à–∏–±–∫–∏
    if (this.isNoisyError(error)) {
      if (this.debugMode) {
        console.log('[Skipped noisy error in context]:', context, error?.message || error);
      }
      return null;
    }
    
    const errorObj = this.normalizeError(error);
    const errorId = this.generateErrorId();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—Ç–æ–∏—Ç –ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É –æ—à–∏–±–∫—É
    if (!this.shouldLogError(errorObj, context)) {
      return null;
    }
    
    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
    this.logError(errorObj, context, metadata, errorId);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    if (this.shouldShowToUser(errorObj)) {
      this.showUserNotification(errorObj, context, errorId);
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞)
    this.sendToAnalytics(errorObj, context, metadata, errorId);
    
    return errorId;
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Å—Ç–æ–∏—Ç –ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É
   */
  shouldLogError(error, context) {
    // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
    if (error.type === this.errorTypes.VALIDATION) {
      return false;
    }
    
    // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ CORS –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
    if (error.type === this.errorTypes.CORS && 
        window.location.protocol === 'file:') {
      return this.debugMode; // –¢–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏
    }
    
    return true;
  }

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –æ—à–∏–±–∫—É –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
   */
  normalizeError(error) {
    // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
    if (error && error.type && error.message) {
      return error;
    }
    
    const errorMessage = typeof error === 'string' ? error : error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
    let errorType = this.errorTypes.UNKNOWN;
    
    if (error instanceof Error) {
      if (errorMessage.includes('CORS') || errorMessage.includes('Cross origin')) {
        errorType = this.errorTypes.CORS;
      } else if (error.name === 'ValidationError' || error.validationErrors) {
        errorType = this.errorTypes.VALIDATION;
      } else if (error.name === 'SyntaxError' || errorMessage.includes('parsing')) {
        errorType = this.errorTypes.PARSING;
      } else if (error.name === 'NetworkError' || errorMessage.includes('network') || 
                 errorMessage.includes('fetch') || errorMessage.includes('HTTP')) {
        errorType = this.errorTypes.NETWORK;
      } else {
        errorType = this.errorTypes.RUNTIME;
      }
    } else if (typeof error === 'string') {
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –æ—à–∏–±–∫–∏
      if (error.includes('CORS') || error.includes('Cross origin')) {
        errorType = this.errorTypes.CORS;
      } else if (error.includes('network') || error.includes('fetch')) {
        errorType = this.errorTypes.NETWORK;
      }
    }
    
    return {
      type: errorType,
      message: errorMessage,
      stack: error?.stack || new Error(errorMessage).stack,
      name: error?.name || 'Error',
      originalError: error
    };
  }

  /**
   * –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
   */
  logError(error, context, metadata, errorId) {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—É—é –∑–∞–ø–∏—Å—å
    const logEntry = {
      timestamp: new Date().toISOString(),
      errorId,
      context,
      errorType: error.type,
      message: error.message.substring(0, 200), // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
      url: window.location.href,
      metadataKeys: Object.keys(metadata)
    };
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ª–æ–≥–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫
    if (this.isImportantError(error)) {
      console.group(`‚ùå –í–ê–ñ–ù–û: –û—à–∏–±–∫–∞ [${errorId}] –≤ ${context}`);
      console.error('–¢–∏–ø:', error.type);
      console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
      console.error('–ö–æ–Ω—Ç–µ–∫—Å—Ç:', context);
      
      if (Object.keys(metadata).length > 0) {
        console.error('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:', metadata);
      }
      
      if (error.stack && error.type !== this.errorTypes.CORS) {
        console.error('–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤:');
        console.error(error.stack);
      }
      
      console.groupEnd();
    } else {
      // –î–ª—è –º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤—ã–≤–æ–¥
      console.warn(`‚ö†Ô∏è [${errorId}] ${context}: ${error.message.substring(0, 100)}`);
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
    if (this.isImportantError(error)) {
      this.saveToErrorLog(logEntry);
    }
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–∞–∂–Ω–æ—Å—Ç—å –æ—à–∏–±–∫–∏
   */
  isImportantError(error) {
    // –û—à–∏–±–∫–∏ CORS –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –Ω–µ –≤–∞–∂–Ω—ã
    if (error.type === this.errorTypes.CORS && window.location.protocol === 'file:') {
      return false;
    }
    
    // –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–µ –≤–∞–∂–Ω—ã –¥–ª—è –ª–æ–≥–∞
    if (error.type === this.errorTypes.VALIDATION) {
      return false;
    }
    
    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤–∞–∂–Ω—ã
    return true;
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—É–ª—É—á—à–µ–Ω–Ω–æ–µ)
   */
  showUserNotification(error, context, errorId) {
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
    if (error.type === this.errorTypes.CORS && window.location.protocol === 'file:') {
      return; // CORS –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ - –Ω–æ—Ä–º–∞
    }
    
    const message = this.getUserFriendlyMessage(error, context);
    
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã—Ç—å
    if (window.showNotification) {
      window.showNotification({
        title: '–û—à–∏–±–∫–∞',
        message: `${message} (–ö–æ–¥: ${errorId})`,
        type: 'error',
        duration: 5000
      });
    } else {
      // Fallback —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π, –Ω–µ –±—ã–ª–æ –ª–∏ —É–∂–µ –ø–æ–¥–æ–±–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      if (!this.wasNotificationShown(errorId)) {
        this.markNotificationShown(errorId);
        const userConfirmed = confirm(`–û—à–∏–±–∫–∞: ${message}\n–ö–æ–¥ –æ—à–∏–±–∫–∏: ${errorId}\n\n–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏?`);
        if (userConfirmed) {
          console.error('–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ—à–∏–±–∫–∏:', error);
        }
      }
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª–æ –ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   */
  wasNotificationShown(errorId) {
    try {
      const shownNotifications = JSON.parse(sessionStorage.getItem('shownErrorNotifications') || '[]');
      return shownNotifications.includes(errorId);
    } catch {
      return false;
    }
  }

  /**
   * –ü–æ–º–µ—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–Ω–æ–µ
   */
  markNotificationShown(errorId) {
    try {
      const shownNotifications = JSON.parse(sessionStorage.getItem('shownErrorNotifications') || '[]');
      shownNotifications.push(errorId);
      // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      if (shownNotifications.length > 20) {
        shownNotifications.shift();
      }
      sessionStorage.setItem('shownErrorNotifications', JSON.stringify(shownNotifications));
    } catch {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    }
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  getUserFriendlyMessage(error, context) {
    const messages = {
      [this.errorTypes.VALIDATION]: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö',
      [this.errorTypes.NETWORK]: '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.',
      [this.errorTypes.PARSING]: '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö',
      [this.errorTypes.CORS]: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞',
      [this.errorTypes.RUNTIME]: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏',
      [this.errorTypes.UNKNOWN]: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    };
    
    let baseMessage = messages[error.type] || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const contextMessages = {
      'saveData': '–ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö',
      'loadData': '–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö',
      'renderChart': '–ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞',
      'exportReport': '–ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –æ—Ç—á–µ—Ç–∞',
      'importTemplate': '–ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —à–∞–±–ª–æ–Ω–∞',
      'Global': '–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏',
      'UnhandledPromiseRejection': '–≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏'
    };
    
    const contextText = contextMessages[context] || (context !== 'Unknown' ? `–≤ ${context}` : '');
    
    return `${baseMessage} ${contextText}`.trim();
  }

  /**
   * –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
   */
  async safeExecute(fn, context, ...args) {
    try {
      return await fn(...args);
    } catch (error) {
      // –î–ª—è –æ—à–∏–±–æ–∫ CORS –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
      const errorMessage = error?.message || error?.toString() || '';
      if (errorMessage.includes('CORS') && window.location.protocol === 'file:') {
        console.warn(`[–õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞] CORS –æ—à–∏–±–∫–∞ –≤ ${context}, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º fallback`);
        return this.getFallbackValue(context, error);
      }
      
      const errorId = this.handle(error, context, { args });
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      return this.getFallbackValue(context, error);
    }
  }

  // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
  // (, , generateErrorId, , 
  // , shouldShowToUser, , 
  // , , , )
  
  


  sendToAnalytics(error, context, metadata, errorId) {
    // –ú–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É (Google Analytics, Yandex.Metrica –∏ —Ç.–¥.)
    if (typeof gtag !== 'undefined') {
      gtag('event', 'exception', {
        description: `${context}: ${error.message}`,
        fatal: false
      });
    }
  }

  handleGlobalError(error) {
    this.handle(error, 'Global');
  }

  handlePromiseRejection(reason) {
    this.handle(reason, 'UnhandledPromiseRejection');
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
   */
  getErrorLog() {
    try {
      return JSON.parse(localStorage.getItem('errorLog') || '[]');
    } catch {
      return [];
    }
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ—à–∏–±–æ–∫
   */
  clearErrorLog() {
    localStorage.removeItem('errorLog');
  }

	getFallbackValue(context, error) {
    const fallbacks = {
      'calculateGrade': 2,
      'calculatePercentage': 0,
      'loadData': null,
      'renderChart': '<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</div>',
      'exportReport': false
    };
    
    return fallbacks[context] !== undefined ? fallbacks[context] : null;
  }

  /**
   * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
   */
  generateErrorId() {
    return `ERR_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  saveToErrorLog(entry) {
    try {
      const errorLog = JSON.parse(localStorage.getItem('errorLog') || '[]');
      errorLog.push(entry);
      
      // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –æ—à–∏–±–æ–∫
      if (errorLog.length > 100) {
        errorLog.splice(0, errorLog.length - 100);
      }
      
      localStorage.setItem('errorLog', JSON.stringify(errorLog));
    } catch (e) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—à–∏–±–∫—É –≤ –ª–æ–≥:', e);
    }
  }

  getAppStateSnapshot() {
    try {
      return {
        dataSize: localStorage.getItem('testAnalyticsData')?.length || 0,
        tasksCount: window.appData?.tasks?.length || 0,
        studentsCount: window.appData?.students?.length || 0
      };
    } catch {
      return {};
    }
  }
  
  /**
   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Ö–µ–º–µ
   */
  validate(data, schema, context = 'validation') {
    try {
      const errors = [];
      
      // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º
      if (schema.required && Array.isArray(schema.required)) {
        schema.required.forEach(field => {
          if (data[field] === undefined || data[field] === null || data[field] === '') {
            errors.push(`–ü–æ–ª–µ "${field}" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`);
          }
        });
      }
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–µ–ª
      if (schema.numbers && Array.isArray(schema.numbers)) {
        schema.numbers.forEach(field => {
          if (data[field] !== undefined && isNaN(parseFloat(data[field]))) {
            errors.push(`–ü–æ–ª–µ "${field}" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º`);
          }
        });
      }
      
      if (errors.length > 0) {
        const error = new Error(errors.join(', '));
        error.type = this.errorTypes.VALIDATION;
        error.validationErrors = errors;
        throw error;
      }
      
      return true;
    } catch (error) {
      this.handle(error, context, { data, schema });
      throw error;
    }
  } 
  
  
  
  
  
  /**
   * –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
   */
  setDebugMode(enabled) {
    this.debugMode = enabled;
    console.log(`–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –æ—à–∏–±–æ–∫: ${enabled ? '–í–ö–õ' : '–í–´–ö–õ'}`);
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç —Å–∏–Ω–≥–ª—Ç–æ–Ω–∞
window.ErrorHandler = new ErrorHandler();