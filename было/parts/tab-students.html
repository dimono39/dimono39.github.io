<h2>üë• –°–ø–∏—Å–æ–∫ —É—á–∞—â–∏—Ö—Å—è</h2>

<div id="studentsContainer">
    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ render.js -->
</div>

<div class="mass-operations" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
    <h4>‚ö° –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h4>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0;">
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞:</label>
            <textarea id="massImportText" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ —É—á–∞—â–∏—Ö—Å—è (–∫–∞–∂–¥–æ–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):&#10;–ò–≤–∞–Ω–æ–≤ –ê–ª–µ–∫—Å–µ–π&#10;–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è&#10;–°–∏–¥–æ—Ä–æ–≤ –î–º–∏—Ç—Ä–∏–π" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;"></textarea>
            <button class="btn btn-success" onclick="importStudentsFromText()" style="margin-top: 10px; width: 100%;">
                üìù –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —É—á–∞—â–∏—Ö—Å—è
            </button>
        </div>
        
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞:</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="number" id="generateCount" min="1" max="50" value="10" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                <button class="btn" onclick="generateStudentsList()">
                    üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
            <div class="form-group">
                <label>–®–∞–±–ª–æ–Ω –∏–º–µ–Ω:</label>
                <select id="nameTemplate" style="width: 100%;">
                    <option value="–£—á–∞—â–∏–π—Å—è {n}">–£—á–∞—â–∏–π—Å—è {n}</option>
                    <option value="–°—Ç—É–¥–µ–Ω—Ç {n}">–°—Ç—É–¥–µ–Ω—Ç {n}</option>
                    <option value="–£—á–µ–Ω–∏–∫ {n}">–£—á–µ–Ω–∏–∫ {n}</option>
                </select>
            </div>
        </div>
        
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º:</label>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn btn-warning" onclick="sortStudentsAlphabetically()">
                    üî§ –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
                </button>
                <button class="btn" onclick="shuffleStudents()">
                    üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Å–ª—É—á–∞–π–Ω–æ
                </button>
                <button class="btn btn-danger" onclick="removeAllStudents()">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö —É—á–∞—â–∏—Ö—Å—è
                </button>
            </div>
        </div>
    </div>
</div>

<div class="students-statistics" style="margin-top: 20px;">
    <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–∞—â–∏–º—Å—è</h4>
    <div id="studentsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0;">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
</div>

<script>
    // –ò–º–ø–æ—Ä—Ç —É—á–∞—â–∏—Ö—Å—è –∏–∑ —Ç–µ–∫—Å—Ç–∞
    function importStudentsFromText() {
        const textarea = document.getElementById('massImportText');
        if (!textarea) return;
        
        const text = textarea.value.trim();
        if (!text) {
            app.showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ —É—á–∞—â–∏—Ö—Å—è!', 'error');
            return;
        }
        
        app.generateStudentsFromText(text);
        textarea.value = '';
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —É—á–∞—â–∏—Ö—Å—è
    function generateStudentsList() {
        const countInput = document.getElementById('generateCount');
        const templateSelect = document.getElementById('nameTemplate');
        
        if (!countInput || !templateSelect) return;
        
        const count = parseInt(countInput.value) || 10;
        const template = templateSelect.value;
        
        if (count < 1 || count > 50) {
            app.showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 50', 'error');
            return;
        }
        
        const names = [];
        for (let i = 1; i <= count; i++) {
            names.push(template.replace('{n}', i));
        }
        
        app.generateStudentsFromText(names.join('\n'));
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    function sortStudentsAlphabetically() {
        if (app.data.students.length === 0) {
            app.showNotification('–ù–µ—Ç —É—á–∞—â–∏—Ö—Å—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏', 'info');
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const studentsWithResults = app.data.students.map((name, index) => ({
            name,
            results: app.data.results[index],
            errors: app.data.errors.filter(e => e.studentIndex === index)
        }));
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏
        studentsWithResults.sort((a, b) => a.name.localeCompare(b.name, 'ru'));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        app.data.students = studentsWithResults.map(s => s.name);
        app.data.results = studentsWithResults.map(s => s.results);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –æ—à–∏–±–æ–∫
        const newErrors = [];
        studentsWithResults.forEach((student, newIndex) => {
            const oldIndex = app.data.students.indexOf(student.name);
            const studentErrors = app.data.errors.filter(e => e.studentIndex === oldIndex);
            studentErrors.forEach(error => {
                newErrors.push({
                    ...error,
                    studentIndex: newIndex
                });
            });
        });
        app.data.errors = newErrors;
        
        app.saveData();
        app.renderAll();
        app.showNotification('–£—á–∞—â–∏–µ—Å—è –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É', 'success');
    }
    
    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ —É—á–∞—â–∏—Ö—Å—è
    function shuffleStudents() {
        if (app.data.students.length < 2) {
            app.showNotification('–ù—É–∂–Ω–æ —Ö–æ—Ç—è –±—ã 2 —É—á–∞—â–∏—Ö—Å—è', 'info');
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –∏–Ω–¥–µ–∫—Å–æ–≤
        const indices = [...Array(app.data.students.length).keys()];
        
        // –ê–ª–≥–æ—Ä–∏—Ç–º –§–∏—à–µ—Ä–∞-–ô–µ—Ç—Å–∞ –¥–ª—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ
        const shuffledStudents = indices.map(i => app.data.students[i]);
        const shuffledResults = indices.map(i => app.data.results[i]);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—à–∏–±–∫–∏
        const newErrors = [];
        indices.forEach((newIndex, oldIndex) => {
            const studentErrors = app.data.errors.filter(e => e.studentIndex === oldIndex);
            studentErrors.forEach(error => {
                newErrors.push({
                    ...error,
                    studentIndex: newIndex
                });
            });
        });
        
        app.data.students = shuffledStudents;
        app.data.results = shuffledResults;
        app.data.errors = newErrors;
        
        app.saveData();
        app.renderAll();
        app.showNotification('–°–ø–∏—Å–æ–∫ —É—á–∞—â–∏—Ö—Å—è –ø–µ—Ä–µ–º–µ—à–∞–Ω', 'success');
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —É—á–∞—â–∏—Ö—Å—è
    function removeAllStudents() {
        if (app.data.students.length === 0) {
            app.showNotification('–ù–µ—Ç —É—á–∞—â–∏—Ö—Å—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'info');
            return;
        }
        
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö ${app.data.students.length} —É—á–∞—â–∏—Ö—Å—è? –í—Å–µ –∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –æ—à–∏–±–∫–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) {
            app.data.students = [];
            app.data.results = [];
            app.data.errors = [];
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            app.data.test.presentStudents = 0;
            document.getElementById('presentStudents').value = 0;
            
            app.saveData();
            app.renderAll();
            app.showNotification('–í—Å–µ —É—á–∞—â–∏–µ—Å—è —É–¥–∞–ª–µ–Ω—ã', 'success');
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É—á–∞—â–∏—Ö—Å—è
    function updateStudentsStatistics() {
        const container = document.getElementById('studentsStats');
        if (!container) return;
        
        const totalStudents = app.data.students.length;
        const totalPresent = app.data.test.presentStudents || 0;
        const absentCount = Math.max(0, (app.data.test.totalStudents || 0) - totalPresent);
        
        // –ü–æ–¥—Å—á–µ—Ç —É—á–∞—â–∏—Ö—Å—è –ø–æ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏
        const gradeCounts = {5: 0, 4: 0, 3: 0, 2: 0};
        app.data.results.forEach(scores => {
            const total = scores.reduce((sum, score) => sum + (score || 0), 0);
            const grade = app.calculateGrade(total);
            gradeCounts[grade] = (gradeCounts[grade] || 0) + 1;
        });
        
        // –ü–æ–¥—Å—á–µ—Ç —É—á–∞—â–∏—Ö—Å—è —Å –æ—à–∏–±–∫–∞–º–∏
        const studentsWithErrors = new Set(app.data.errors.map(e => e.studentIndex)).size;
        
        container.innerHTML = `
            <div class="kpi-card">
                <div class="kpi-value">${totalStudents}</div>
                <div class="kpi-label">–í—Å–µ–≥–æ —É—á–∞—â–∏—Ö—Å—è</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">${absentCount}</div>
                <div class="kpi-label">–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">${studentsWithErrors}</div>
                <div class="kpi-label">–° –æ—à–∏–±–∫–∞–º–∏</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">${gradeCounts[5]}</div>
                <div class="kpi-label">–ù–∞ "5"</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">${gradeCounts[4]}</div>
                <div class="kpi-label">–ù–∞ "4"</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">${gradeCounts[3]}</div>
                <div class="kpi-label">–ù–∞ "3"</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">${gradeCounts[2]}</div>
                <div class="kpi-label">–ù–∞ "2"</div>
            </div>
        `;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', updateStudentsStatistics);
    setInterval(updateStudentsStatistics, 5000);
</script>