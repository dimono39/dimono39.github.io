<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Неоновый Странник + Gemini AI</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud {
            padding: 20px;
            color: #fff;
            text-shadow: 0 0 10px #0ff;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }
        
        #ai-message-box {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 20, 40, 0.9);
            border: 1px solid #0ff;
            padding: 10px 20px;
            border-radius: 5px;
            color: #0ff;
            text-align: center;
            display: none;
            max-width: 80%;
            z-index: 4;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }
        
        /* New Oracle Modal */
        #oracle-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #0f0;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 20;
            pointer-events: auto;
            box-shadow: 0 0 30px #0f0;
        }
        
        #oracle-response {
            color: #0f0;
            margin: 20px 0;
            min-height: 50px;
            text-align: center;
            font-size: 18px;
            line-height: 1.4;
        }

        #start-screen, #game-over-screen, #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 10;
        }

        h1 {
            color: #0ff;
            text-shadow: 0 0 20px #0ff;
            font-size: 48px;
            margin-bottom: 10px;
            text-align: center;
        }

        p {
            color: #fff;
            font-size: 18px;
            text-align: center;
            line-height: 1.5;
            max-width: 600px;
        }

        .input-group {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 400px;
        }

        input[type="text"] {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #0ff;
            color: #fff;
            padding: 10px;
            font-family: inherit;
            width: 100%;
            font-size: 16px;
            text-align: center;
            box-shadow: 0 0 5px #0ff;
        }
        
        #oracle-input {
            border-color: #0f0;
            box-shadow: 0 0 5px #0f0;
            color: #0f0;
        }

        .btn {
            padding: 15px 40px;
            background: transparent;
            border: 2px solid #f0f;
            color: #f0f;
            font-size: 24px;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 15px #f0f;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            background: #f0f;
            color: #000;
        }
        
        .btn-ai {
            border-color: #0ff;
            color: #0ff;
            box-shadow: 0 0 15px #0ff;
            font-size: 18px;
            padding: 10px 20px;
        }
        
        .btn-ai:hover {
            background: #0ff;
            color: #000;
        }
        
        .btn-oracle {
            border-color: #0f0;
            color: #0f0;
            box-shadow: 0 0 15px #0f0;
            font-size: 16px;
            padding: 8px 16px;
        }
        
        .btn-oracle:hover {
            background: #0f0;
            color: #000;
        }

        #mobile-controls {
            display: none;
            width: 100%;
            height: 150px;
            padding-bottom: 20px;
            pointer-events: auto;
            justify-content: space-between;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
            box-sizing: border-box;
        }

        .control-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 30px;
            user-select: none;
            backdrop-filter: blur(5px);
        }
        
        .interaction-hint {
            position: absolute;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%);
            color: #0f0;
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border: 1px solid #0f0;
            display: none;
            font-size: 14px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        .loader {
            border: 5px solid #333;
            border-top: 5px solid #0ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            h1 { font-size: 32px; }
            .hud { font-size: 18px; }
            #mobile-controls { display: flex; }
            .btn { width: 80%; }
            .interaction-hint { bottom: 200px; }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud">
            <span id="score-display">СЧЕТ: 0</span>
            <span id="level-display">УРОВЕНЬ: 1</span>
        </div>
        
        <div id="ai-message-box">
            <strong id="ai-title">Заголовок</strong><br>
            <small id="ai-desc">Описание</small>
        </div>
        
        <div id="interaction-hint" class="interaction-hint">▼ ГОВОРИТЬ С ОРАКУЛОМ</div>
        
        <div id="mobile-controls">
            <div class="d-pad">
                <div class="control-btn" id="btn-left">←</div>
                <div class="control-btn" id="btn-right">→</div>
            </div>
            <div class="action-pad">
                <div class="control-btn" id="btn-down">↓</div>
                <div class="control-btn" id="btn-jump">↑</div>
            </div>
        </div>
    </div>
    
    <!-- Oracle Modal -->
    <div id="oracle-modal">
        <h2 style="color:#0f0; margin:0;">ОРАКУЛ</h2>
        <div id="oracle-response">Спрашивай, путник...</div>
        <div class="input-group" style="width:100%">
            <input type="text" id="oracle-input" placeholder="Напр: 'Как тут не умереть?'">
            <button class="btn btn-oracle" id="oracle-ask-btn">✨ СПРОСИТЬ</button>
            <button class="btn btn-oracle" style="border-color:#666; color:#888;" id="oracle-close-btn">ЗАКРЫТЬ</button>
        </div>
    </div>

    <div id="start-screen">
        <h1>НЕОНОВЫЙ СТРАННИК</h1>
        <p>Создайте уровень через AI или играйте в классику.</p>
        
        <div class="input-group">
            <input type="text" id="ai-prompt" placeholder="Опишите уровень (напр: 'Лавовый замок')">
            <button class="btn btn-ai" id="ai-start-btn">✨ Создать через AI</button>
        </div>
        
        <button class="btn" id="start-btn">Обычная Игра</button>
        <p style="margin-top: 15px; color: #666; font-size: 12px;">Управление: Стрелки / WASD / Пробел</p>
    </div>
    
    <div id="loading-screen" style="display: none;">
        <div class="loader"></div>
        <p id="loading-text">Нейросеть строит уровень...</p>
    </div>

    <div id="game-over-screen" style="display: none;">
        <h1 id="go-title">ИГРА ОКОНЧЕНА</h1>
        <p id="go-score">Ваш счет: 0</p>
        <p id="go-message" style="color: #f0f; font-style: italic; margin-bottom: 20px;">Анализ причины смерти...</p>
        <button class="btn" id="restart-btn">В МЕНЮ</button>
    </div>

<script>
// --- КОНФИГУРАЦИЯ API ---
const apiKey = ""; // Ключ подставится автоматически

/**
 * АУДИО ДВИЖОК
 */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const Sound = {
    playTone: (freq, type, duration, vol = 0.1) => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    },
    jump: () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    },
    collect: () => {
        Sound.playTone(1200, 'sine', 0.1, 0.1);
        setTimeout(() => Sound.playTone(1800, 'triangle', 0.15, 0.1), 50);
    },
    explode: () => {
        Sound.playTone(100, 'sawtooth', 0.3, 0.2);
        Sound.playTone(50, 'square', 0.4, 0.2);
    },
    interact: () => {
        Sound.playTone(800, 'square', 0.1, 0.1);
        setTimeout(() => Sound.playTone(1200, 'square', 0.1, 0.1), 100);
    },
    win: () => {
        Sound.playTone(440, 'sine', 0.2);
        setTimeout(() => Sound.playTone(554, 'sine', 0.2), 150);
        setTimeout(() => Sound.playTone(659, 'sine', 0.4), 300);
    }
};

/**
 * ИГРОВОЙ ДВИЖОК
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const GRAVITY = 0.6;
const FRICTION = 0.8;
const JUMP_FORCE = -12;
const SPEED = 5;

let gameState = 'MENU'; 
let score = 0;
let level = 1;
let isAIMode = false;
let currentLevelTheme = "Classic Neon"; // Для контекста AI
let camera = { x: 0, y: 0 };

const keys = { right: false, left: false, up: false, down: false };

let player;
let platforms = [];
let coins = [];
let hazards = [];
let particles = [];
let terminals = []; // NPCs
let exitPortal = null;

class Player {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.w = 30;
        this.h = 30;
        this.dx = 0;
        this.dy = 0;
        this.grounded = false;
        this.doubleJump = true;
        this.color = '#0ff';
        this.dead = false;
    }

    update() {
        if (this.dead) return;

        if (keys.right) this.dx += 1;
        if (keys.left) this.dx -= 1;
        if (this.dx > SPEED) this.dx = SPEED;
        if (this.dx < -SPEED) this.dx = -SPEED;
        this.dx *= FRICTION;
        this.dy += GRAVITY;
        this.x += this.dx;
        this.y += this.dy;

        this.grounded = false;
        platforms.forEach(p => {
            if (this.x < p.x + p.w && this.x + this.w > p.x && this.y < p.y + p.h && this.y + this.h > p.y) {
                const overlapX = (this.w + p.w) / 2 - Math.abs((this.x + this.w / 2) - (p.x + p.w / 2));
                const overlapY = (this.h + p.h) / 2 - Math.abs((this.y + this.h / 2) - (p.y + p.h / 2));
                if (overlapX < overlapY) {
                    if (this.dx > 0) this.x = p.x - this.w;
                    else this.x = p.x + p.w;
                    this.dx = 0;
                } else {
                    if (this.dy > 0) {
                        this.y = p.y - this.h;
                        this.grounded = true;
                        this.doubleJump = true;
                        this.dy = 0;
                    } else {
                        this.y = p.y + p.h;
                        this.dy = 0;
                    }
                }
            }
        });

        if (this.y > 2000) this.die("void");

        for (let i = coins.length - 1; i >= 0; i--) {
            const c = coins[i];
            if (rectIntersect(this, c)) {
                coins.splice(i, 1);
                score += 10;
                Sound.collect();
                createParticles(c.x + c.w/2, c.y + c.h/2, '#ff0', 10);
                document.getElementById('score-display').innerText = `СЧЕТ: ${score}`;
            }
        }

        hazards.forEach(h => {
            if (rectIntersect(this, h)) this.die("spike");
        });
        
        // Взаимодействие с терминалом
        let nearTerminal = false;
        terminals.forEach(t => {
            const dist = Math.abs((this.x + this.w/2) - (t.x + t.w/2));
            if (dist < 50 && Math.abs(this.y - t.y) < 50) {
                nearTerminal = true;
                if (keys.down) {
                    keys.down = false; // Trigger once
                    openOracle(t);
                }
            }
        });
        
        const hintEl = document.getElementById('interaction-hint');
        if (nearTerminal && gameState === 'PLAYING') hintEl.style.display = 'block';
        else hintEl.style.display = 'none';

        if (exitPortal && rectIntersect(this, exitPortal)) nextLevel();
    }

    jump() {
        if (this.grounded) {
            this.dy = JUMP_FORCE;
            this.grounded = false;
            Sound.jump();
            createParticles(this.x + this.w/2, this.y + this.h, '#fff', 5);
        } else if (this.doubleJump) {
            this.dy = JUMP_FORCE * 0.9;
            this.doubleJump = false;
            Sound.jump();
            createParticles(this.x + this.w/2, this.y + this.h, '#0ff', 5);
        }
    }

    die(cause) {
        if (this.dead) return;
        this.dead = true;
        Sound.explode();
        createParticles(this.x + this.w/2, this.y + this.h/2, '#f00', 30);
        setTimeout(() => gameOver(cause), 1000);
    }

    draw() {
        if (this.dead) return;
        ctx.save();
        ctx.fillStyle = this.color;
        ctx.shadowBlur = 15;
        ctx.shadowColor = this.color;
        ctx.fillRect(this.x, this.y, this.w, this.h);
        ctx.fillStyle = '#000';
        if (this.dx >= 0) ctx.fillRect(this.x + 18, this.y + 6, 6, 6);
        else ctx.fillRect(this.x + 6, this.y + 6, 6, 6);
        ctx.restore();
    }
}

class Particle {
    constructor(x, y, color) {
        this.x = x;
        this.y = y;
        this.size = Math.random() * 5 + 2;
        this.speedX = Math.random() * 6 - 3;
        this.speedY = Math.random() * 6 - 3;
        this.color = color;
        this.life = 1.0;
    }
    update() {
        this.x += this.speedX;
        this.y += this.speedY;
        this.life -= 0.03;
        this.size *= 0.95;
    }
    draw() {
        ctx.fillStyle = this.color;
        ctx.globalAlpha = this.life;
        ctx.fillRect(this.x, this.y, this.size, this.size);
        ctx.globalAlpha = 1.0;
    }
}

function rectIntersect(r1, r2) {
    return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y);
}

function createParticles(x, y, color, count) {
    for (let i = 0; i < count; i++) particles.push(new Particle(x, y, color));
}

// ГЕНЕРАЦИЯ УРОВНЯ
function loadLevel(lvl, aiData = null) {
    platforms = [];
    coins = [];
    hazards = [];
    particles = [];
    terminals = [];
    
    let mapString = "";
    let platformChance = 0.6;
    let hazardChance = lvl > 1 ? 0.5 : 0.2;
    let coinChance = 0.5;
    let width = 20 + lvl * 5; 

    if (aiData) {
        mapString = aiData.terrain;
        width = mapString.length;
        platformChance = aiData.platformDensity;
        hazardChance = aiData.hazardDensity;
        coinChance = aiData.coinDensity;
        currentLevelTheme = aiData.themeName;
        
        const msgBox = document.getElementById('ai-message-box');
        document.getElementById('ai-title').innerText = aiData.themeName;
        document.getElementById('ai-desc').innerText = aiData.briefing;
        msgBox.style.display = 'block';
        setTimeout(() => { msgBox.style.display = 'none'; }, 5000);
    } else {
        currentLevelTheme = `Уровень ${lvl}: Сектор 7`;
        for (let i = 0; i < width; i++) {
            if (i === 0 || i === width - 1) mapString += 'W';
            else if (Math.random() > 0.8 && i > 5) mapString += '0';
            else mapString += '1';
        }
        document.getElementById('ai-message-box').style.display = 'none';
    }

    let currentX = 0;
    const groundY = canvas.height - 60;
    
    player = new Player(100, groundY - 100);
    
    // Добавляем Оракула в начале уровня
    terminals.push({ x: 200, y: groundY - 50, w: 30, h: 50, active: true });

    for (let i = 0; i < width; i++) {
        const char = mapString[i] || '1';
        
        if (char === '1' || char === 'W') {
            platforms.push({ x: currentX, y: groundY, w: 100, h: 60, type: 'ground' });
            
            if (Math.random() < platformChance) {
                let h = Math.random() * 150 + 80;
                platforms.push({ x: currentX, y: groundY - h, w: 80, h: 20, type: 'plat' });
                if (Math.random() < coinChance) {
                    coins.push({ x: currentX + 30, y: groundY - h - 40, w: 20, h: 20 });
                }
                else if (Math.random() < hazardChance) {
                    hazards.push({ x: currentX + 20, y: groundY - h - 20, w: 40, h: 20 });
                }
            }

            if (i > 5 && i < width - 5 && Math.random() < hazardChance * 0.5) {
                hazards.push({ x: currentX + 20, y: groundY - 30, w: 40, h: 30 });
            }
        }
        currentX += 100;
    }

    exitPortal = { x: currentX - 150, y: groundY - 120, w: 50, h: 80 };
    platforms.push({ x: currentX - 200, y: groundY, w: 200, h: 60, type: 'ground' });
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

function loop() {
    if (gameState !== 'PLAYING') return;

    ctx.fillStyle = '#050505';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    let targetCamX = player.x - canvas.width / 2 + player.w / 2;
    if (targetCamX < 0) targetCamX = 0;
    camera.x += (targetCamX - camera.x) * 0.1;

    ctx.save();
    ctx.translate(-camera.x, 0);

    // Отрисовка
    platforms.forEach(p => {
        ctx.fillStyle = '#111';
        ctx.strokeStyle = '#0f0';
        ctx.lineWidth = 2;
        ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.strokeRect(p.x, p.y, p.w, p.h);
    });
    
    // Терминал (Оракул)
    terminals.forEach(t => {
        ctx.fillStyle = '#000';
        ctx.strokeStyle = '#0f0';
        ctx.lineWidth = 2;
        ctx.fillRect(t.x, t.y, t.w, t.h);
        ctx.strokeRect(t.x, t.y, t.w, t.h);
        // Экран
        ctx.fillStyle = `rgba(0, 255, 0, ${Math.random() * 0.5 + 0.2})`;
        ctx.fillRect(t.x + 5, t.y + 5, t.w - 10, 15);
    });

    ctx.fillStyle = '#0f0';
    ctx.shadowBlur = 20;
    ctx.fillRect(exitPortal.x, exitPortal.y, exitPortal.w, exitPortal.h);
    
    ctx.shadowBlur = 10;
    ctx.shadowColor = '#ff0';
    ctx.fillStyle = '#ff0';
    coins.forEach(c => {
        let offset = Math.sin(Date.now() / 200) * 5;
        ctx.beginPath();
        ctx.arc(c.x + c.w/2, c.y + c.h/2 + offset, 10, 0, Math.PI * 2);
        ctx.fill();
    });

    ctx.shadowColor = '#f00';
    ctx.fillStyle = '#f00';
    hazards.forEach(h => {
        ctx.beginPath();
        ctx.moveTo(h.x, h.y + h.h);
        ctx.lineTo(h.x + h.w / 2, h.y);
        ctx.lineTo(h.x + h.w, h.y + h.h);
        ctx.fill();
    });

    for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].draw();
        if (particles[i].life <= 0) particles.splice(i, 1);
    }

    player.update();
    player.draw();

    ctx.restore();
    requestAnimationFrame(loop);
}

// --- GEMINI AI FUNCS ---

// 1. AI генератор уровней
async function generateAILevel(userPrompt) {
    const loadingScreen = document.getElementById('loading-screen');
    loadingScreen.style.display = 'flex';
    document.getElementById('start-screen').style.display = 'none';
    
    const systemPrompt = `You are a level designer. Output JSON only.
    Fields: themeName (Russian string), briefing (Russian string), terrain (50 chars of '1' ground, '0' gap), platformDensity (0.0-1.0), hazardDensity (0.0-1.0), coinDensity (0.0-1.0).
    User Request: ${userPrompt || "Cyberpunk"}`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
        });
        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;
        const levelData = JSON.parse(text.replace(/```json|```/g, '').trim());
        startAILevel(levelData);
    } catch (e) {
        console.error(e);
        loadingScreen.style.display = 'none';
        startGame(false);
    }
}

// 2. AI Оракул
function openOracle(terminal) {
    gameState = 'PAUSED';
    Sound.interact();
    document.getElementById('oracle-modal').style.display = 'flex';
    document.getElementById('oracle-response').innerText = `Приветствую. Я Оракул сектора "${currentLevelTheme}". Спрашивай.`;
}

async function askOracle() {
    const input = document.getElementById('oracle-input');
    const question = input.value;
    const responseBox = document.getElementById('oracle-response');
    
    if (!question) return;
    
    responseBox.innerText = "Связь с матрицей...";
    
    // Контекст для AI
    const systemPrompt = `You are a cryptic hologram in a platformer game. 
    Level Theme: ${currentLevelTheme}. 
    User Question: ${question}.
    Reply in Russian. Be short (max 2 sentences), mysterious, but helpful. Mention game mechanics (jumping, spikes) if relevant.`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
        });
        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;
        responseBox.innerText = text;
        input.value = '';
    } catch (e) {
        responseBox.innerText = "Ошибка соединения. Матрица недоступна.";
    }
}

document.getElementById('oracle-ask-btn').addEventListener('click', askOracle);
document.getElementById('oracle-close-btn').addEventListener('click', () => {
    document.getElementById('oracle-modal').style.display = 'none';
    gameState = 'PLAYING';
    loop();
});

// 3. AI Экран смерти
async function getDeathTaunt(cause) {
    const msgEl = document.getElementById('go-message');
    msgEl.innerText = "Анализ гибели...";
    
    const causeText = cause === 'void' ? 'Falling into abyss' : 'Impaled by spikes';
    const systemPrompt = `Player died in a cyberpunk game. Cause: ${causeText}. Score: ${score}.
    Write a short, sarcastic, 1-sentence 'Game Over' message in Russian. Be witty.`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
        });
        const data = await response.json();
        msgEl.innerText = data.candidates[0].content.parts[0].text;
    } catch (e) {
        msgEl.innerText = "Система уничтожена.";
    }
}

function startAILevel(data) {
    document.getElementById('loading-screen').style.display = 'none';
    score = 0; level = 1; isAIMode = true;
    document.getElementById('score-display').innerText = 'СЧЕТ: 0';
    document.getElementById('level-display').innerText = 'AI MODE';
    gameState = 'PLAYING';
    loadLevel(1, data);
    loop();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function startGame(ai = false) {
    if (ai) {
        const prompt = document.getElementById('ai-prompt').value;
        generateAILevel(prompt);
        return;
    }
    document.getElementById('start-screen').style.display = 'none';
    score = 0; level = 1; isAIMode = false;
    document.getElementById('score-display').innerText = 'СЧЕТ: 0';
    document.getElementById('level-display').innerText = 'УРОВЕНЬ: 1';
    gameState = 'PLAYING';
    loadLevel(level);
    loop();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function nextLevel() {
    Sound.win();
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,canvas.width, canvas.height);
    if (isAIMode) {
        gameState = 'GAMEOVER';
        document.getElementById('go-score').innerText = `Счет: ${score}`;
        document.getElementById('go-title').innerText = "ПОБЕДА";
        document.getElementById('go-message').innerText = "Вы пережили симуляцию.";
        document.getElementById('game-over-screen').style.display = 'flex';
    } else {
        level++;
        document.getElementById('level-display').innerText = `УРОВЕНЬ: ${level}`;
        loadLevel(level);
    }
}

function gameOver(cause) {
    gameState = 'GAMEOVER';
    document.getElementById('go-score').innerText = `Счет: ${score}`;
    document.getElementById('go-title').innerText = "ИГРА ОКОНЧЕНА";
    document.getElementById('game-over-screen').style.display = 'flex';
    getDeathTaunt(cause);
}

// INPUTS
window.addEventListener('keydown', e => {
    if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
    if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
    if ((e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') && !keys.up) {
        keys.up = true;
        if (gameState === 'PLAYING') player.jump();
    }
    if (e.code === 'ArrowDown' || e.code === 'KeyS') keys.down = true;
});
window.addEventListener('keyup', e => {
    if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
    if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
    if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') keys.up = false;
    if (e.code === 'ArrowDown' || e.code === 'KeyS') keys.down = false;
});

const addTouch = (elem, code) => {
    elem.addEventListener('touchstart', (e) => { e.preventDefault(); keys[code] = true; if(code==='up' && gameState === 'PLAYING') player.jump(); });
    elem.addEventListener('touchend', (e) => { e.preventDefault(); keys[code] = false; });
};
addTouch(document.getElementById('btn-left'), 'left');
addTouch(document.getElementById('btn-right'), 'right');
addTouch(document.getElementById('btn-jump'), 'up');
addTouch(document.getElementById('btn-down'), 'down');

document.getElementById('start-btn').addEventListener('click', () => startGame(false));
document.getElementById('ai-start-btn').addEventListener('click', () => startGame(true));
document.getElementById('restart-btn').addEventListener('click', () => {
    document.getElementById('game-over-screen').style.display = 'none';
    document.getElementById('start-screen').style.display = 'flex';
});
</script>
</body>
</html>